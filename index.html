<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="小戴的博客">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="小戴的博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Daiiiiiiiiiii">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>小戴的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">小戴的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/10/%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1%E5%8F%8A%E7%83%AD%E5%B8%96%E6%8E%92%E8%A1%8C%E6%A8%A1%E5%9D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Daiiiiiiiiiii">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小戴的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/10/%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1%E5%8F%8A%E7%83%AD%E5%B8%96%E6%8E%92%E8%A1%8C%E6%A8%A1%E5%9D%97/" class="post-title-link" itemprop="url">数据统计及热帖排行模块</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-09-10 13:05:34 / 修改时间：13:05:54" itemprop="dateCreated datePublished" datetime="2022-09-10T13:05:34+08:00">2022-09-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">项目笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="14-数据统计"><a href="#14-数据统计" class="headerlink" title="14. 数据统计"></a>14. 数据统计</h1><ul>
<li>UV:(Unique Visitor)<ul>
<li>独立访客,需通过用户 IP 排重统计数据.</li>
<li>每次访问都要进行统计</li>
<li>HyperLogLog, 性能好，且存储空间小(0.81%的误差)</li>
</ul>
</li>
<li>DAU(Daily Active User)<ul>
<li>日活跃用户,需通过用户 ID 排重统计数据</li>
<li>访问过一次,则认为其活跃</li>
<li>Bitmap，性能好，且可以统计精确的结果</li>
</ul>
</li>
</ul>
<h2 id="14-1-RedisUtil"><a href="#14-1-RedisUtil" class="headerlink" title="14.1 RedisUtil"></a>14.1 RedisUtil</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UV (网站访问用户数量---根据Ip地址统计(包括没有登录的用户))</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PREFIX_UV</span> <span class="operator">=</span> <span class="string">&quot;uv&quot;</span>;</span><br><span class="line"><span class="comment">// DAU (活跃用户数量---根据userId)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PREFIX_DAU</span> <span class="operator">=</span> <span class="string">&quot;dau&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 存储单日ip访问数量（uv）--HyperLogLog ---k:时间 v:ip  (HyperLogLog)</span></span><br><span class="line"><span class="comment"> * 示例：uv:20220526 = ip1,ip2,ip3,...</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getUVKey</span><span class="params">(String date)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> PREFIX_UV + SPLIT + date;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取区间ip访问数量（uv）</span></span><br><span class="line"><span class="comment"> * 示例：uv:20220525:20220526 = ip1,ip2,ip3,...</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getUVKey</span><span class="params">(String startDate, String endDate)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> PREFIX_UV + SPLIT + startDate + SPLIT + endDate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 存储单日活跃用户（dau）--BitMap ---k:date v:userId索引下为true  (BitMap)</span></span><br><span class="line"><span class="comment"> * 示例：dau:20220526 = userId1索引--(true),userId2索引--(true),....</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDAUKey</span><span class="params">(String date)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> PREFIX_DAU + SPLIT + date;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取区间活跃用户</span></span><br><span class="line"><span class="comment"> * 示例：dau:20220526:20220526</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDAUKey</span><span class="params">(String startDate, String endDate)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> PREFIX_DAU + SPLIT + startDate + SPLIT + endDate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="14-2-DataService"><a href="#14-2-DataService" class="headerlink" title="14.2 DataService"></a>14.2 DataService</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将Date类型转化为String类型</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">SimpleDateFormat</span> <span class="variable">df</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyyMMdd&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*********************** HypeLogLog*************************/</span></span><br><span class="line"><span class="comment">// 将指定ip计入UV---k:当前时间 v:ip</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordUV</span><span class="params">(String ip)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> RedisKeyUtil.getUVKey(df.format(<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">    redisTemplate.opsForHyperLogLog().add(redisKey, ip);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 统计指定日期范围内的ip访问数UV</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">calculateUV</span><span class="params">(Date start, Date end)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (start == <span class="literal">null</span> || end == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;参数不能为空！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (start.after(end)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;请输入正确的时间段！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 整理该日期范围内的Key</span></span><br><span class="line">    List&lt;String&gt; keyList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="type">Calendar</span> <span class="variable">calendar</span> <span class="operator">=</span> Calendar.getInstance();</span><br><span class="line">    calendar.setTime(start);</span><br><span class="line">    <span class="keyword">while</span> (!calendar.getTime().after(end)) &#123;</span><br><span class="line">        <span class="comment">// 获取该日期范围内的每一天的Key存入集合</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisKeyUtil.getUVKey(df.format(calendar.getTime()));</span><br><span class="line">        keyList.add(key);</span><br><span class="line">        <span class="comment">// 日期+1(按照日历格式)</span></span><br><span class="line">        calendar.add(Calendar.DATE, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 合并日期范围内相同的ip</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> RedisKeyUtil.getUVKey(df.format(start), df.format(end));</span><br><span class="line">    <span class="comment">// 获取keyList中的每一列key进行合并</span></span><br><span class="line">    redisTemplate.opsForHyperLogLog().union(redisKey, keyList.toArray());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回统计结果</span></span><br><span class="line">    <span class="keyword">return</span> redisTemplate.opsForHyperLogLog().size(redisKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*********************** BitMap *****************************/</span></span><br><span class="line"><span class="comment">// 将指定用户计入DAU --k:当前时间 v:userId</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordDAU</span><span class="params">(<span class="type">int</span> userId)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> RedisKeyUtil.getDAUKey(df.format(<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">    redisTemplate.opsForValue().setBit(redisKey, userId, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 统计指定日期范围内的DAU日活跃用户</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">calculateDAU</span><span class="params">(Date start, Date end)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (start == <span class="literal">null</span> || end == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;参数不能为空！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (start.before(end)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;请输入正确的时间段！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 整理该日期范围内的Key</span></span><br><span class="line">    List&lt;<span class="type">byte</span>[]&gt; keyList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="type">Calendar</span> <span class="variable">calendar</span> <span class="operator">=</span> Calendar.getInstance();</span><br><span class="line">    calendar.setTime(start);</span><br><span class="line">    <span class="keyword">while</span> (!calendar.getTime().after(end)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisKeyUtil.getDAUKey(df.format(calendar.getTime()));</span><br><span class="line">        keyList.add(key.getBytes());</span><br><span class="line">        <span class="comment">// 日期+1(按照日历格式)</span></span><br><span class="line">        calendar.add(Calendar.DATE, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 进行OR运算</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="type">long</span>) redisTemplate.execute(<span class="keyword">new</span> <span class="title class_">RedisCallback</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">doInRedis</span><span class="params">(RedisConnection connection)</span> <span class="keyword">throws</span> DataAccessException &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> RedisKeyUtil.getDAUKey(df.format(start), df.format(end));</span><br><span class="line"></span><br><span class="line">            connection.bitOp(RedisStringCommands.BitOperation.OR, redisKey.getBytes(), keyList.toArray(<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>][<span class="number">0</span>]));</span><br><span class="line">            <span class="keyword">return</span> connection.bitCount(redisKey.getBytes());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);&#125;</span><br></pre></td></tr></table></figure>

<h2 id="14-3-DataInterceptor"><a href="#14-3-DataInterceptor" class="headerlink" title="14.3 DataInterceptor"></a>14.3 DataInterceptor</h2><p>在datainterceptor拦截器中调用service每次请求最开始调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataService dataService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HostHolder hostHolder;</span><br><span class="line">    <span class="comment">// 在所有请求之前存用户访问数和日活跃人数</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 获取请求用户的ip地址，统计UV</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> request.getRemoteHost();</span><br><span class="line">        dataService.recordUV(ip);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 统计DAU</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> hostHolder.getUser();</span><br><span class="line">        <span class="keyword">if</span> (user != <span class="literal">null</span>) &#123;</span><br><span class="line">            dataService.recordDAU(user.getId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*****************************注册拦截器*********************************/</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebMvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataInterceptor dataInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(dataInterceptor)</span><br><span class="line">          .excludePathPatterns(<span class="string">&quot;/* */*.css&quot;</span>, <span class="string">&quot;/ **/ *.js&quot;</span>, <span class="string">&quot;/* */*.png&quot;</span>, <span class="string">&quot;/**/ *.jpg&quot;</span>, <span class="string">&quot;/* */*.jpeg&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="14-4-DataController"><a href="#14-4-DataController" class="headerlink" title="14.4 DataController"></a>14.4 DataController</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 统计页面</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/data&quot;, method = &#123;RequestMethod.GET, RequestMethod.POST&#125;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getDataPage</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/site/admin/data&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 统计网站UV(ip访问数量)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@DateTimeFormat</span>将时间参数转化为字符串</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;/data/uv&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getUV</span><span class="params">(<span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> Date start, <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> Date end, Model model)</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">uv</span> <span class="operator">=</span> dataService.calculateUV(start, end);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;uvResult&quot;</span>, uv);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;uvStartDate&quot;</span>, start);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;uvEndDate&quot;</span>, end);</span><br><span class="line">    <span class="comment">// 转发到 /data请求</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;forward:/data&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 统计网站DAU(登录用户访问数量)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;/data/dau&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getDAU</span><span class="params">(<span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> Date start, <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> Date end, Model model)</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">dau</span> <span class="operator">=</span> dataService.calculateDAU(start, end);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;dauResult&quot;</span>, dau);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;dauStartDate&quot;</span>, start);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;dauEndDate&quot;</span>, end);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;forward:/data&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="14-5-添加权限"><a href="#14-5-添加权限" class="headerlink" title="14.5 添加权限"></a>14.5 添加权限</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.antMatchers(</span><br><span class="line">        <span class="string">&quot;/discuss/delete&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/data/**&quot;</span></span><br><span class="line">)</span><br><span class="line">.hasAnyAuthority(</span><br><span class="line">        AUTHORITY_ADMIN</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="14-6-前端核心"><a href="#14-6-前端核心" class="headerlink" title="14.6 前端核心"></a>14.6 前端核心</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 网站UV (活跃用户类似)--&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h6</span>&gt;</span> 网站 访问人数<span class="tag">&lt;/<span class="name">h6</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/data/uv&#125;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;start&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;#dates.format(uvStartDate,&#x27;yyyy-MM-dd&#x27;)&#125;&quot;</span> <span class="attr">type</span>=<span class="string">&quot;date&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;end&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;#dates.format(uvEndDate,&#x27;yyyy-MM-dd&#x27;)&#125;&quot;</span> <span class="attr">type</span>=<span class="string">&quot;date&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>开始统计<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">        统计结果</span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;uvResult&#125;&quot;</span>&gt;</span>访问人数<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="15-热帖排行"><a href="#15-热帖排行" class="headerlink" title="15. 热帖排行"></a>15. 热帖排行</h1><h2 id="15-1-Quartz"><a href="#15-1-Quartz" class="headerlink" title="15.1 Quartz"></a>15.1 Quartz</h2><h3 id="15-1-1-分布式换环境定时任务"><a href="#15-1-1-分布式换环境定时任务" class="headerlink" title="15.1.1 分布式换环境定时任务"></a>15.1.1 分布式换环境定时任务</h3><p>Schedule每隔一段时间做同样的事情，做的任务会重复</p>
<p><img src="/img/image-20220815180436895.png" alt="image-20220815180436895"></p>
<p>Quartz定时任务驱动的参数存到数据库里，通过排队加锁等这样的机制实现共享</p>
<p><img src="/img/image-20220815180045372.png" alt="image-20220815180045372"></p>
<h3 id="15-1-2-JDK线程池"><a href="#15-1-2-JDK线程池" class="headerlink" title="15.1.2 JDK线程池"></a>15.1.2 JDK线程池</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@ContextConfiguration(classes = CommunityApplication.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolTests</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// JDK普通线程池</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// JDK可执行定时任务的线程池</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">ScheduledExecutorService</span> <span class="variable">scheduledExecutorService</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 封装阻塞方法</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">(<span class="type">long</span> m)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Thread.sleep(m);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 1.JDK普通线程池</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testExecutorService</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;Hello ExecutorService&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">      <span class="comment">// 循环执行十次</span></span><br><span class="line">      executorService.submit(task);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">10000</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2.JDK定时任务线程池</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testScheduledExecutorService</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; Hello ScheduledExecutorService&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 10000：延迟时间，2000：任务执行时间间隔</span></span><br><span class="line">    scheduledExecutorService.scheduleAtFixedRate(task, <span class="number">10000</span>, <span class="number">2000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">    sleep(<span class="number">30000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="15-1-3-Spring线程池"><a href="#15-1-3-Spring线程池" class="headerlink" title="15.1.3 Spring线程池"></a>15.1.3 Spring线程池</h3><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 核心线程数量</span></span><br><span class="line"><span class="attr">spring.task.execution.pool.core-size</span>=<span class="string">5</span></span><br><span class="line"><span class="comment"># 线程不够调用时 自动扩容上限</span></span><br><span class="line"><span class="attr">spring.task.execution.pool.max-size</span>=<span class="string">15</span></span><br><span class="line"><span class="comment"># 队列容量，最大容量也不够用时，放入队列进行缓冲</span></span><br><span class="line"><span class="attr">spring.task.execution.pool.queue-capacity</span>=<span class="string">100</span></span><br><span class="line"><span class="comment"># TaskSchedulingProperties</span></span><br><span class="line"><span class="comment"># 可执行定时任务的Spirng线程池 线程数量</span></span><br><span class="line"><span class="attr">spring.task.scheduling.pool.size</span>=<span class="string">5</span></span><br></pre></td></tr></table></figure>

<p><strong>ThreadPoolConfig</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">// 启动Spring可定时任务线程池</span></span><br><span class="line"><span class="meta">@EnableScheduling</span></span><br><span class="line"><span class="comment">// 启动@Async注解实现线程池</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolConfig</span> &#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@ContextConfiguration(classes =  CommunityApplication.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolTests</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Spring普通线程池</span></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> ThreadPoolTaskExecutor taskExecutor;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Spring可执行定时任务的线程池</span></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> ThreadPoolTaskScheduler taskScheduler;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 封装阻塞方法</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">(<span class="type">long</span> m)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Thread.sleep(m);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3.Spring普通线程池</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testThreadPoolTaskExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; Hello ThreadPoolTaskExecutor&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">      taskExecutor.submit(task);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">10000</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 4.Spring定时任务线程池</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testThreadPoolTaskScheduler</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; Hello ThreadPoolTaskScheduler&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">Date</span> <span class="variable">startTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis() + <span class="number">10000</span>);</span><br><span class="line">    <span class="comment">// 1000：时间间隔</span></span><br><span class="line">    taskScheduler.scheduleAtFixedRate(task, startTime, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">30000</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 5.Spring普通线程池(注解简化)</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testThreadPoolTaskExecutorSimple</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">      testService.execute1();</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">10000</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 6.Spring定时任务线程池(注解简化)</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testThreadPoolTaskSchedulerSimple</span><span class="params">()</span> &#123;</span><br><span class="line">    sleep(<span class="number">30000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="15-1-4-Quartz"><a href="#15-1-4-Quartz" class="headerlink" title="15.1.4 Quartz"></a>15.1.4 Quartz</h3><h4 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h4><ul>
<li>scheduler接口：核心调度工具，所有任务由这一接口调用</li>
<li>job：定义任务，重写execute方法</li>
<li>JobDetail接口：配置描述</li>
<li>Trigger接口：什么时候运行，以什么样的频率运行<br>启动后，配置信息存入数据库，只在第一次启用</li>
</ul>
<h4 id="导入数据库"><a href="#导入数据库" class="headerlink" title="导入数据库"></a>导入数据库</h4><ul>
<li>qrtz_job_details：job详情配置描述表</li>
<li>qrtz_simple_triggers：触发器相关配置简述</li>
<li>qrtz_jtriggers：触发器相关完整配置</li>
<li>qrtz_scheduler：定时器状态</li>
<li>qrtz_locks：定时器锁</li>
</ul>
<h4 id="配置文件-1"><a href="#配置文件-1" class="headerlink" title="配置文件"></a>配置文件</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-quartz<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># QuartzProperties</span></span><br><span class="line"><span class="comment"># 存储方式</span></span><br><span class="line"><span class="attr">spring.quartz.job-store-type</span>=<span class="string">jdbc </span></span><br><span class="line"><span class="comment"># 调度器名字</span></span><br><span class="line"><span class="attr">spring.quartz.scheduler-name</span>=<span class="string">communityScheduler</span></span><br><span class="line"><span class="comment"># 调度器id自动生成</span></span><br><span class="line"><span class="attr">spring.quartz.properties.org.quartz.scheduler.instanceId</span>=<span class="string">AUTO </span></span><br><span class="line"><span class="comment"># 存入数据库的类</span></span><br><span class="line"><span class="attr">spring.quartz.properties.org.quartz.jobStore.class</span>=<span class="string">org.quartz.impl.jdbcjobstore.JobStoreTX </span></span><br><span class="line"><span class="comment"># 驱动</span></span><br><span class="line"><span class="attr">spring.quartz.properties.org.quartz.jobStore.driverDelegateClass</span>=<span class="string">org.quartz.impl.jdbcjobstore.StdJDBCDelegate </span></span><br><span class="line"><span class="comment"># 采用集群</span></span><br><span class="line"><span class="attr">spring.quartz.properties.org.quartz.jobStore.isClustered</span>=<span class="string">true </span></span><br><span class="line"><span class="comment"># 用哪个线程池</span></span><br><span class="line"><span class="attr">spring.quartz.properties.org.quartz.threadPool.class</span>=<span class="string">org.quartz.simpl.SimpleThreadPool </span></span><br><span class="line"><span class="comment"># 线程池数量</span></span><br><span class="line"><span class="attr">spring.quartz.properties.org.quartz.threadPool.threadCount</span>=<span class="string">5 </span></span><br></pre></td></tr></table></figure>

<h4 id="QuartzConfig"><a href="#QuartzConfig" class="headerlink" title="QuartzConfig"></a>QuartzConfig</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AlphaJob</span> <span class="keyword">implements</span> <span class="title class_">Job</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;: execute a quartz job.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * FactoryBean可简化Bean的实例化过程:</span></span><br><span class="line"><span class="comment"> * 	1. 通过FactoryBean封装Bean的实例化过程.</span></span><br><span class="line"><span class="comment"> * 	2. 将FactoryBean装配到Spring容器里.</span></span><br><span class="line"><span class="comment"> * 	3. 将FactoryBean注入给其他的Bean.</span></span><br><span class="line"><span class="comment"> *	4. 该Bean得到的是FactoryBean所管理的对象实例.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置(初始化一次) -&gt; 数据库 -&gt; 调用</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QuartzConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 配置JobDetail</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="keyword">public</span> JobDetailFactoryBean <span class="title function_">alphaJobDetail</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">JobDetailFactoryBean</span> <span class="variable">factoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JobDetailFactoryBean</span>();</span><br><span class="line">    <span class="comment">//声明管理哪个类</span></span><br><span class="line">    factoryBean.setJobClass(AlphaJob.class);</span><br><span class="line">    <span class="comment">// 声明job任务的名字</span></span><br><span class="line">    factoryBean.setName(<span class="string">&quot;alphaJob&quot;</span>);</span><br><span class="line">    <span class="comment">// 声明任务属于的组</span></span><br><span class="line">    factoryBean.setGroup(<span class="string">&quot;alphaJobGroup&quot;</span>);</span><br><span class="line">    <span class="comment">// 声明任务是否长久保存</span></span><br><span class="line">    factoryBean.setDurability(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// 声明任务是否可恢复</span></span><br><span class="line">    factoryBean.setRequestsRecovery(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> factoryBean;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** </span></span><br><span class="line"><span class="comment">    *配置Trigger(SimpleTriggerFactoryBean, CronTriggerFactoryBean)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="keyword">public</span> SimpleTriggerFactoryBean <span class="title function_">alphaTrigger</span><span class="params">(JobDetail alphaJobDetail)</span> &#123;</span><br><span class="line">    <span class="type">SimpleTriggerFactoryBean</span> <span class="variable">factoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleTriggerFactoryBean</span>();</span><br><span class="line">    factoryBean.setJobDetail(alphaJobDetail);</span><br><span class="line">    factoryBean.setName(<span class="string">&quot;alphaTrigger&quot;</span>);</span><br><span class="line">    factoryBean.setGroup(<span class="string">&quot;alphaTriggerGroup&quot;</span>);</span><br><span class="line">    <span class="comment">// 声明任务执行的频率</span></span><br><span class="line">    factoryBean.setRepeatInterval(<span class="number">3000</span>);</span><br><span class="line">    <span class="comment">// 声明Trigger的存储状态类型</span></span><br><span class="line">    factoryBean.setJobDataMap(<span class="keyword">new</span> <span class="title class_">JobDataMap</span>());</span><br><span class="line">    <span class="keyword">return</span> factoryBean;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@ContextConfiguration(classes = CommunityApplication.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolTests</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Quartz</span></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> Scheduler scheduler;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> TestService testService;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 封装阻塞方法</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">(<span class="type">long</span> m)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Thread.sleep(m);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清除quartz中存入数据库的线程池</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDeleteJob</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> scheduler.deleteJob(<span class="keyword">new</span> <span class="title class_">JobKey</span>(<span class="string">&quot;quartzJob&quot;</span>, <span class="string">&quot;alphaJobGroup&quot;</span>));</span><br><span class="line">      System.out.println(result);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="15-2-RedisUtil"><a href="#15-2-RedisUtil" class="headerlink" title="15.2 RedisUtil"></a>15.2 RedisUtil</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 热帖分数 (把需要更新的帖子id存入Redis当作缓存)*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PREFIX_POST</span> <span class="operator">=</span> <span class="string">&quot;post&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**帖子分数 (发布、点赞、加精、评论时放入)*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getPostScore</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> PREFIX_POST + SPLIT + <span class="string">&quot;score&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="15-3-计算分数"><a href="#15-3-计算分数" class="headerlink" title="15.3 计算分数"></a>15.3 计算分数</h2><h3 id="15-3-1-发布帖子时初始化分数"><a href="#15-3-1-发布帖子时初始化分数" class="headerlink" title="15.3.1 发布帖子时初始化分数"></a>15.3.1 发布帖子时初始化分数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 计算帖子分数</span></span><br><span class="line"><span class="comment">  * 将新发布的帖子id存入set去重的redis集合------addDiscussPost()</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> RedisKeyUtil.getPostScore();</span><br><span class="line">redisTemplate.opsForSet().add(redisKey, post.getId());</span><br></pre></td></tr></table></figure>

<h3 id="15-3-2-点赞时计算帖子分数"><a href="#15-3-2-点赞时计算帖子分数" class="headerlink" title="15.3.2 点赞时计算帖子分数"></a>15.3.2 点赞时计算帖子分数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 计算帖子分数</span></span><br><span class="line"><span class="comment">  * 将点赞过的帖子id存入set去重的redis集合------like()</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">if</span> (entityType == ENTITY_TYPE_POST) &#123;</span><br><span class="line">  <span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> RedisKeyUtil.getPostScore();</span><br><span class="line">  <span class="comment">//点赞会有重复动作，而set不允许重复，效率会比队列更好</span></span><br><span class="line">  redisTemplate.opsForSet().add(redisKey, postId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="15-3-3-评论时计算帖子分数"><a href="#15-3-3-评论时计算帖子分数" class="headerlink" title="15.3.3 评论时计算帖子分数"></a>15.3.3 评论时计算帖子分数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (comment.getEntityType() == ENTITY_TYPE_POST) &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 计算帖子分数</span></span><br><span class="line"><span class="comment">    * 将评论过的帖子id存入set去重的redis集合------addComment()</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> RedisKeyUtil.getPostScore();</span><br><span class="line">  redisTemplate.opsForSet().add(redisKey, discussPostId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="15-3-4-加精时计算帖子分数"><a href="#15-3-4-加精时计算帖子分数" class="headerlink" title="15.3.4 加精时计算帖子分数"></a>15.3.4 加精时计算帖子分数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 计算帖子分数</span></span><br><span class="line"><span class="comment">  * 将加精的帖子id存入set去重的redis集合-------setWonderful()</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> RedisKeyUtil.getPostScore();</span><br><span class="line">redisTemplate.opsForSet().add(redisKey, id);</span><br></pre></td></tr></table></figure>

<h2 id="15-4-Quartz热帖排行Job"><a href="#15-4-Quartz热帖排行Job" class="headerlink" title="15.4 Quartz热帖排行Job"></a>15.4 Quartz热帖排行Job</h2><ul>
<li><p>重写execute</p>
<ul>
<li>取到上一步存的rediskey</li>
<li>如果没有数据变化，打个日志任务取消</li>
<li>否则开始刷新前刷新后都记日志</li>
<li>遍历刷新</li>
</ul>
</li>
<li><p>刷新方法</p>
<ul>
<li>得到帖子id</li>
<li>如果帖子不在了打个日志</li>
<li>更新帖子分数，同步es搜索数据（在相应的Mapper和Config里添加响应方法）</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**热帖排行定时刷新任务**/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PostScoreRefreshJob</span> <span class="keyword">implements</span> <span class="title class_">Job</span>, CommunityConstant &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(PostScoreRefreshJob.class);</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DiscussPostService discussPostService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LikeService likeService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ElasticsearchService elasticsearchService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 网站创建时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Date epoch;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            epoch = <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>).parse(<span class="string">&quot;2014-10-22 00:00:00&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;初始化时间失败!&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(JobExecutionContext jobExecutionContext)</span> <span class="keyword">throws</span> JobExecutionException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> RedisKeyUtil.getPostScore();</span><br><span class="line">        <span class="comment">// 处理每一个key</span></span><br><span class="line">        <span class="type">BoundSetOperations</span> <span class="variable">operations</span> <span class="operator">=</span> redisTemplate.boundSetOps(redisKey);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (operations.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;[任务取消] 没有需要刷新的帖子&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;[任务开始] 正在刷新帖子分数&quot;</span> + operations.size());</span><br><span class="line">        <span class="keyword">while</span> (operations.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 刷新每一个从set集合里弹出的postId</span></span><br><span class="line">            <span class="built_in">this</span>.refresh((Integer)operations.pop());</span><br><span class="line">        &#125;</span><br><span class="line">        logger.info(<span class="string">&quot;[任务结束] 帖子分数刷新完毕！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 从redis中取出每一个value:postId</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">(<span class="type">int</span> postId)</span> &#123;</span><br><span class="line">        <span class="type">DiscussPost</span> <span class="variable">post</span> <span class="operator">=</span> discussPostService.findDiscussPostById(postId);</span><br><span class="line">        <span class="keyword">if</span> (post == <span class="literal">null</span>) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;该帖子不存在：id = &quot;</span> + postId);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(post.getStatus() == <span class="number">2</span>)&#123;</span><br><span class="line">            logger.error(<span class="string">&quot;帖子已被删除&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 帖子分数计算公式：[加精（75）+ 评论数*  10 + 点赞数*  2] + 距离天数</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// 是否加精帖子</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">wonderful</span> <span class="operator">=</span> post.getStatus() == <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 点赞数量</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">liketCount</span> <span class="operator">=</span> likeService.findEntityLikeCount(ENTITY_TYPE_POST, postId);</span><br><span class="line">        <span class="comment">// 评论数量</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">commentCount</span> <span class="operator">=</span> post.getCommentCount();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算权重</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">weight</span> <span class="operator">=</span> (wonderful ? <span class="number">75</span> : <span class="number">0</span>) + commentCount*  <span class="number">10</span> + liketCount*  <span class="number">2</span>;</span><br><span class="line">        <span class="comment">// 分数 = 取对数(帖子权重) + 距离天数</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">score</span> <span class="operator">=</span> Math.log10(Math.max(weight, <span class="number">1</span>)) + (post.getCreateTime().getTime() - epoch.getTime()) / (<span class="number">1000</span>*  <span class="number">3600</span>* <span class="number">24</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新帖子分数</span></span><br><span class="line">        discussPostService.updateScore(postId, score);</span><br><span class="line">        <span class="comment">// 同步搜索数据</span></span><br><span class="line">        post.setScore(score);</span><br><span class="line">        elasticsearchService.saveDiscussPost(post);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="15-5-QuartzConfig"><a href="#15-5-QuartzConfig" class="headerlink" title="15.5 QuartzConfig"></a>15.5 QuartzConfig</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 刷新帖子分数任务</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> JobDetailFactoryBean <span class="title function_">postScoreRefreshJobDetail</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">JobDetailFactoryBean</span> <span class="variable">factoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JobDetailFactoryBean</span>();</span><br><span class="line">    factoryBean.setJobClass(PostScoreRefreshJob.class);</span><br><span class="line">    factoryBean.setName(<span class="string">&quot;postScoreRefreshJob&quot;</span>);</span><br><span class="line">    factoryBean.setGroup(<span class="string">&quot;communityJobGroup&quot;</span>);</span><br><span class="line">    factoryBean.setDurability(<span class="literal">true</span>);</span><br><span class="line">    factoryBean.setRequestsRecovery(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> factoryBean;</span><br><span class="line">&#125;	</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> SimpleTriggerFactoryBean <span class="title function_">postScoreRefreshTrigger</span><span class="params">(JobDetail postScoreRefreshJobDetail)</span> &#123;</span><br><span class="line">    <span class="type">SimpleTriggerFactoryBean</span> <span class="variable">factoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleTriggerFactoryBean</span>();</span><br><span class="line">    factoryBean.setJobDetail(postScoreRefreshJobDetail);</span><br><span class="line">    factoryBean.setName(<span class="string">&quot;postScoreRefreshTrigger&quot;</span>);</span><br><span class="line">    factoryBean.setGroup(<span class="string">&quot;communityTriggerGroup&quot;</span>);</span><br><span class="line">    factoryBean.setRepeatInterval(<span class="number">1000</span> * <span class="number">60</span> * <span class="number">5</span>);</span><br><span class="line">    factoryBean.setJobDataMap(<span class="keyword">new</span> <span class="title class_">JobDataMap</span>());</span><br><span class="line">    <span class="keyword">return</span> factoryBean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="15-6-排序显示"><a href="#15-6-排序显示" class="headerlink" title="15.6 排序显示"></a>15.6 排序显示</h2><h3 id="15-6-1-后端核心"><a href="#15-6-1-后端核心" class="headerlink" title="15.6.1 后端核心"></a>15.6.1 后端核心</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//************************DiscussPostMapper***************************  </span></span><br><span class="line"><span class="comment">// 添加参数 orderMode =0：最新  =1：最热</span></span><br><span class="line">List&lt;DiscussPost&gt; <span class="title function_">selectDiscussPosts</span><span class="params">(<span class="type">int</span> userId, <span class="type">int</span> offset, <span class="type">int</span> limit, <span class="type">int</span> orderMode)</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&lt;</span><span class="keyword">select</span> id<span class="operator">=</span>&quot;selectDiscussPosts&quot; resultType<span class="operator">=</span>&quot;DiscussPost&quot;<span class="operator">&gt;</span></span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">    <span class="operator">&lt;</span>include refid<span class="operator">=</span>&quot;selectFields&quot;<span class="operator">&gt;</span><span class="operator">&lt;</span><span class="operator">/</span>include<span class="operator">&gt;</span></span><br><span class="line">    <span class="keyword">from</span> discuss_post</span><br><span class="line">    <span class="keyword">where</span> status<span class="operator">!=</span><span class="number">2</span></span><br><span class="line">    <span class="operator">&lt;</span>if test<span class="operator">=</span>&quot;userId!=0&quot;<span class="operator">&gt;</span></span><br><span class="line">        <span class="keyword">and</span> user_id<span class="operator">=</span>#&#123;userId&#125;</span><br><span class="line">    <span class="operator">&lt;</span><span class="operator">/</span>if<span class="operator">&gt;</span></span><br><span class="line">    <span class="operator">&lt;</span>if test<span class="operator">=</span>&quot;orderMode==0&quot;<span class="operator">&gt;</span></span><br><span class="line">        <span class="keyword">order</span> <span class="keyword">by</span> type <span class="keyword">desc</span>,create_time <span class="keyword">desc</span></span><br><span class="line">    <span class="operator">&lt;</span><span class="operator">/</span>if<span class="operator">&gt;</span></span><br><span class="line">    <span class="operator">&lt;</span>if test<span class="operator">=</span>&quot;orderMode==1&quot;<span class="operator">&gt;</span></span><br><span class="line">        <span class="keyword">order</span> <span class="keyword">by</span> type <span class="keyword">desc</span>,score <span class="keyword">desc</span>,create_time <span class="keyword">desc</span></span><br><span class="line">    <span class="operator">&lt;</span><span class="operator">/</span>if<span class="operator">&gt;</span></span><br><span class="line">    limit #&#123;<span class="keyword">offset</span>&#125;,#&#123;limit&#125;</span><br><span class="line"><span class="operator">&lt;</span><span class="operator">/</span><span class="keyword">select</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//************************DiscussPostService***************************  </span></span><br><span class="line"><span class="keyword">public</span> List&lt;DiscussPost&gt; <span class="title function_">findDiscussPosts</span><span class="params">(<span class="type">int</span> userId, <span class="type">int</span> offset, <span class="type">int</span> limit, <span class="type">int</span> orderMode)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> discussPostMapper.selectDiscussPosts(userId, offset, limit, orderMode);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//************************HomeController***************************  </span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/index&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="comment">// @RequestParam(name = &quot;orderMode&quot;) 这是从前端传参数方法是：/index?xx 与Controller绑定</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getIndexPage</span><span class="params">(Model model, Page page,<span class="meta">@RequestParam(name = &quot;orderMode&quot;,defaultValue = &quot;0&quot;)</span> <span class="type">int</span> orderMode)</span> &#123;</span><br><span class="line"></span><br><span class="line">  page.setRows(discussPostService.findDiscussPostRows(<span class="number">0</span>));</span><br><span class="line">  page.setPath(<span class="string">&quot;/index?orderMode=&quot;</span> + orderMode);</span><br><span class="line"></span><br><span class="line">  List&lt;DiscussPost&gt; list = discussPostService.findDiscussPosts(<span class="number">0</span>, page.getOffset(), page.getLimit(), orderMode);</span><br><span class="line">  List&lt;Map&lt;String, Object&gt;&gt; discussPost = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (list!=<span class="literal">null</span>)&#123;</span><br><span class="line">    <span class="keyword">for</span>(DiscussPost post:list) &#123;</span><br><span class="line">      HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">      map.put(<span class="string">&quot;post&quot;</span>, post);</span><br><span class="line">      <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserById(post.getUserId());</span><br><span class="line">      map.put(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">      <span class="type">long</span> <span class="variable">likeCount</span> <span class="operator">=</span> likeService.findEntityLikeCount(ENTITY_TYPE_POST, post.getId());</span><br><span class="line">      map.put(<span class="string">&quot;likeCount&quot;</span>, likeCount);</span><br><span class="line">      discussPost.add(map);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  model.addAttribute(<span class="string">&quot;discussPosts&quot;</span>, discussPost);</span><br><span class="line">  model.addAttribute(<span class="string">&quot;orderMode&quot;</span>, orderMode);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;/index&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="15-6-2-前端核心"><a href="#15-6-2-前端核心" class="headerlink" title="15.6.2 前端核心"></a>15.6.2 前端核心</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 切换最新/最热帖子 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;nav-item&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:class</span>=<span class="string">&quot;|nav-link $&#123;orderMode==0?&#x27;active&#x27;:&#x27;&#x27;&#125;|&quot;</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/index(orderMode=0)&#125;&quot;</span>&gt;</span>最新<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;nav-item&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:class</span>=<span class="string">&quot;|nav-link $&#123;orderMode==1?&#x27;active&#x27;:&#x27;&#x27;&#125;|&quot;</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/index(orderMode=1)&#125;&quot;</span>&gt;</span>最新<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id=""><a href="#" class="headerlink" title=""></a></h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/10/%E7%B3%BB%E7%BB%9F%E9%80%9A%E7%9F%A5%E5%8F%8A%E6%90%9C%E7%B4%A2%E6%A8%A1%E5%9D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Daiiiiiiiiiii">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小戴的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/10/%E7%B3%BB%E7%BB%9F%E9%80%9A%E7%9F%A5%E5%8F%8A%E6%90%9C%E7%B4%A2%E6%A8%A1%E5%9D%97/" class="post-title-link" itemprop="url">系统通知及搜索模块</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-09-10 13:04:02 / 修改时间：13:04:30" itemprop="dateCreated datePublished" datetime="2022-09-10T13:04:02+08:00">2022-09-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">项目笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="10-系统通知"><a href="#10-系统通知" class="headerlink" title="10. 系统通知"></a>10. 系统通知</h1><h2 id="10-1-阻塞队列"><a href="#10-1-阻塞队列" class="headerlink" title="10.1 阻塞队列"></a>10.1 阻塞队列</h2><ul>
<li>生产者线程<ul>
<li>线程需要实现 Runnable 接口</li>
<li>重写接口的run方法</li>
<li>声明变量<code>private BlockingQueue&lt;Integer&gt; queue</code>接受传入的阻塞队列</li>
<li>创建有参构造器</li>
<li>实现示例逻辑，生产100个数据，put进阻塞队列，每生产一个数据停顿20毫秒，输出信息</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Producer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> BlockingQueue&lt;Integer&gt; queue;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">Producer</span><span class="params">(BlockingQueue&lt;Integer&gt; queue)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.queue = queue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">        Thread.sleep(<span class="number">20</span>);</span><br><span class="line">        queue.put(i);</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;生产:&quot;</span> + queue.size());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>消费者线程<ul>
<li>线程需要实现 Runnable 接口</li>
<li>重写接口的run方法</li>
<li>声明变量<code>private BlockingQueue&lt;Integer&gt; queue</code>接受传入的阻塞队列</li>
<li>创建有参构造器</li>
<li>实现示例逻辑，不停的从队列中take，每生产一个数据停顿0-1000随机毫秒，输出信息</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Consumer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> BlockingQueue&lt;Integer&gt; queue;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">Consumer</span><span class="params">(BlockingQueue&lt;Integer&gt; queue)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.queue = queue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        Thread.sleep(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">1000</span>));</span><br><span class="line">        queue.take();</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;消费:&quot;</span> + queue.size());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>main函数<ul>
<li>实例化阻塞队列<code>BlockingQueue queue = new ArrayBlockingQueue(10);</code></li>
<li>实例化一个生产者线程</li>
<li>实例化三个消费者线程</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">BlockingQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Producer</span>(queue)).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Consumer</span>(queue)).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Consumer</span>(queue)).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Consumer</span>(queue)).start();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="10-2-整合kafka"><a href="#10-2-整合kafka" class="headerlink" title="10.2 整合kafka"></a>10.2 整合kafka</h2><h3 id="10-2-1-配置文件"><a href="#10-2-1-配置文件" class="headerlink" title="10.2.1 配置文件"></a>10.2.1 配置文件</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-kafka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># KafkaProperties</span></span><br><span class="line"><span class="attr">spring.kafka.bootstrap-servers</span>=<span class="string">localhost:9092</span></span><br><span class="line"><span class="attr">spring.kafka.consumer.group-id</span>=<span class="string">test-consumer-group</span></span><br><span class="line"><span class="attr">spring.kafka.consumer.enable-auto-commit</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">spring.kafka.consumer.auto-commit-interval</span>=<span class="string">3000</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kafka一级目录启动</span><br><span class="line">启动zookeeper</span><br><span class="line">bin\windows\zookeeper-server-start.bat config\zookeeper.properties</span><br><span class="line"></span><br><span class="line">启动kafka</span><br><span class="line">bin\windows\kafka-server-start.bat config\server.properties</span><br></pre></td></tr></table></figure>

<h2 id="10-3-发布系统通知"><a href="#10-3-发布系统通知" class="headerlink" title="10.3 发布系统通知"></a>10.3 发布系统通知</h2><p>在评论点赞关注以后，就不用管他，扔进队列，并发异步。</p>
<p>异步：理解为你派小弟去干个活，你该干啥还是干啥。如果需要小弟完事后向你汇报，这就是有回调的异步，反之亦然。</p>
<h3 id="10-3-1-生产者"><a href="#10-3-1-生产者" class="headerlink" title="10.3.1 生产者"></a>10.3.1 生产者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * description: 生产者 触发事件时调用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventProducer</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Resource</span></span><br><span class="line">  <span class="keyword">private</span> KafkaTemplate kafkaTemplate;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 处理事件</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fireEvent</span><span class="params">(Event event)</span> &#123;</span><br><span class="line">    <span class="comment">// 将事件发布到指定的主题,内容为event对象转化的json字符串</span></span><br><span class="line">    kafkaTemplate.send(event.getTopic(), JSONObject.toJSONString(event));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10-3-2-消费者"><a href="#10-3-2-消费者" class="headerlink" title="10.3.2 消费者"></a>10.3.2 消费者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * description: Kafka事件消费者 (被动调用)</span></span><br><span class="line"><span class="comment"> * 对Message表扩充：1：系统通知，当生产者调用时，存入消息队列，消费者自动调用将event事件相关信息存入Message表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventConsumer</span> <span class="keyword">implements</span> <span class="title class_">CommunityConst</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(EventConsumer.class);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> MessageService messageService;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 处理事件</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@KafkaListener(topics = &#123;TOPIC_COMMENT, TOPIC_LIKE, TOPIC_FOLLOW&#125;)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessages</span><span class="params">(ConsumerRecord record)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (record == <span class="literal">null</span> || record.value() == <span class="literal">null</span>) &#123;</span><br><span class="line">      logger.error(<span class="string">&quot;消息的内容为空!&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将消息内容字符串 转化为 Event对象</span></span><br><span class="line">    <span class="type">Event</span> <span class="variable">event</span> <span class="operator">=</span> JSONObject.parseObject(record.value().toString(), Event.class);</span><br><span class="line">    <span class="comment">// 注意：event中若data = null,是fastjson依赖版本的问题(不能太高1.0.xx)</span></span><br><span class="line">    <span class="keyword">if</span> (event == <span class="literal">null</span>) &#123;</span><br><span class="line">      logger.error(<span class="string">&quot;消息格式错误!&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 发送站内通知</span></span><br><span class="line">    <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">    message.setFromId(SYSTEM_USER_ID);</span><br><span class="line">    <span class="comment">// Message表中ToId设置为被发起事件的用户id</span></span><br><span class="line">    message.setToId(event.getEntityUserId());</span><br><span class="line">    <span class="comment">// ConversationId设置为事件的主题（点赞、评论、关注）</span></span><br><span class="line">    message.setConversationId(event.getTopic());</span><br><span class="line">    message.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消息具体内容</span></span><br><span class="line">    HashMap&lt;String, Object&gt; content = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    content.put(<span class="string">&quot;userId&quot;</span>, event.getUserId());</span><br><span class="line">    content.put(<span class="string">&quot;entityId&quot;</span>, event.getEntityId());</span><br><span class="line">    content.put(<span class="string">&quot;entityType&quot;</span>, event.getEntityType());</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!event.getData().isEmpty()) &#123;</span><br><span class="line">      content.putAll(event.getData());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将content(map类型)转化成字符串类型封装进message</span></span><br><span class="line">    message.setContent(JSONObject.toJSONString(content));</span><br><span class="line">    messageService.addMessage(message);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10-3-3-常量"><a href="#10-3-3-常量" class="headerlink" title="10.3.3 常量"></a>10.3.3 常量</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CommunityConstant</span> &#123;</span><br><span class="line">  <span class="comment">/** Kafka主题: 评论*/</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">TOPIC_COMMENT</span> <span class="operator">=</span> <span class="string">&quot;comment&quot;</span>;</span><br><span class="line">  <span class="comment">/** Kafka主题: 点赞*/</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">TOPIC_LIKE</span> <span class="operator">=</span> <span class="string">&quot;like&quot;</span>;</span><br><span class="line">  <span class="comment">/** Kafka主题: 关注*/</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">TOPIC_FOLLOW</span> <span class="operator">=</span> <span class="string">&quot;follow&quot;</span>;</span><br><span class="line">  <span class="comment">/** 系统用户ID*/</span></span><br><span class="line">  <span class="type">int</span> <span class="variable">SYSTEM_USER_ID</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10-3-4-Controller"><a href="#10-3-4-Controller" class="headerlink" title="10.3.4 Controller"></a>10.3.4 Controller</h3><h4 id="触发评论通知"><a href="#触发评论通知" class="headerlink" title="触发评论通知"></a>触发评论通知</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/comment&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommentController</span> <span class="keyword">implements</span> <span class="title class_">CommunityConst</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * description: 添加评论</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> discussPostId 用于重定向回当前帖子页</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@RequestMapping(value = &quot;/add/&#123;discussPostId&#125;&quot;, method = RequestMethod.POST)</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">addComment</span><span class="params">(<span class="meta">@PathVariable(&quot;discussPostId&quot;)</span> <span class="type">int</span> discussPostId, Comment comment)</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    commentService.addComment(comment);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 触发评论事件</span></span><br><span class="line"><span class="comment">     * 评论完后，调用Kafka生产者，发送系统通知</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">Event</span> <span class="variable">event</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Event</span>()</span><br><span class="line">        .setTopic(TOPIC_COMMENT)</span><br><span class="line">        .setEntityId(comment.getEntityId())</span><br><span class="line">        .setEntityType(comment.getEntityType())</span><br><span class="line">        .setUserId(hostHolder.getUser().getId())</span><br><span class="line">        .setData(<span class="string">&quot;postId&quot;</span>, discussPostId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * event.setEntityUserId要分情况设置被赞的id</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 1.评论的是帖子，被发起事件（评论）的用户-&gt;该帖子发布人id</span></span><br><span class="line"><span class="comment">     * 2.评论的是用户的评论，被发起事件（评论）的用户-&gt;该评论发布人id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (comment.getEntityType() == ENTITY_TYPE_POST) &#123;</span><br><span class="line">      <span class="comment">// 评论帖子</span></span><br><span class="line">      <span class="type">DiscussPost</span> <span class="variable">target</span> <span class="operator">=</span> discussPostService.findPost(comment.getEntityId());</span><br><span class="line">      event.setEntityUserId(target.getUserId());</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (comment.getEntityType() == ENTITY_TYPE_COMMENT) &#123;</span><br><span class="line">      <span class="comment">// 回复</span></span><br><span class="line">      <span class="type">Comment</span> <span class="variable">target</span> <span class="operator">=</span> commentService.findCommentById(comment.getEntityId());</span><br><span class="line">      event.setEntityUserId(target.getUserId());</span><br><span class="line">    &#125;</span><br><span class="line">    eventProducer.fireEvent(event);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:/discuss/detail/&quot;</span> + discussPostId;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="触发点赞通知"><a href="#触发点赞通知" class="headerlink" title="触发点赞通知"></a>触发点赞通知</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LikeController</span> <span class="keyword">implements</span> <span class="title class_">CommunityConst</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@RequestMapping(value = &quot;like&quot;, method = RequestMethod.POST)</span></span><br><span class="line">  <span class="meta">@ResponseBody</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">like</span><span class="params">(<span class="type">int</span> entityType, <span class="type">int</span> entityId, <span class="type">int</span> entityUserId, <span class="type">int</span> postId)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> hostHolder.getUser();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//点赞</span></span><br><span class="line">    likeService.like(user.getId(), entityType, entityId, entityUserId);</span><br><span class="line">    <span class="comment">// 数量</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">likeCount</span> <span class="operator">=</span> likeService.findEntityLikeCount(entityType, entityId);</span><br><span class="line">    <span class="comment">// 状态</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">likeStatus</span> <span class="operator">=</span> likeService.findEntityLikeStatus(user.getId(), entityType, entityId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 触发点赞事件</span></span><br><span class="line"><span class="comment">     * 只有点赞完后，才会调用Kafka生产者，发送系统通知，取消点赞不会调用事件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (likeStatus == <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="type">Event</span> <span class="variable">event</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Event</span>()</span><br><span class="line">          .setTopic(TOPIC_LIKE)</span><br><span class="line">          .setEntityId(entityId)</span><br><span class="line">          .setEntityType(entityType)</span><br><span class="line">          .setUserId(user.getId())</span><br><span class="line">          .setEntityUserId(entityUserId)</span><br><span class="line">          .setData(<span class="string">&quot;postId&quot;</span>, postId);</span><br><span class="line">      <span class="comment">// 注意：data里面存postId是因为点击查看后链接到具体帖子的页面</span></span><br><span class="line">      eventProducer.fireEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;likeCount&quot;</span>, likeCount);</span><br><span class="line">    map.put(<span class="string">&quot;likeStatus&quot;</span>, likeStatus);</span><br><span class="line">    <span class="keyword">return</span> CommunityUtil.getJSONString(<span class="number">0</span>, <span class="literal">null</span>, map);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="触发关注通知"><a href="#触发关注通知" class="headerlink" title="触发关注通知"></a>触发关注通知</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FollowController</span> <span class="keyword">implements</span> <span class="title class_">CommunityConst</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 关注</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@RequestMapping(path = &quot;/follow&quot;, method = RequestMethod.POST)</span></span><br><span class="line">  <span class="meta">@ResponseBody</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">follow</span><span class="params">(<span class="type">int</span> entityType, <span class="type">int</span> entityId)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> hostHolder.getUser();</span><br><span class="line"></span><br><span class="line">    followService.follow(user.getId(), entityType, entityId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 触发关注事件</span></span><br><span class="line"><span class="comment">     * 关注完后，调用Kafka生产者，发送系统通知</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">Event</span> <span class="variable">event</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Event</span>()</span><br><span class="line">        .setTopic(TOPIC_FOLLOW)</span><br><span class="line">        .setUserId(hostHolder.getUser().getId())</span><br><span class="line">        .setEntityType(entityType)</span><br><span class="line">        .setEntityId(entityId)</span><br><span class="line">        .setEntityUserId(entityId);</span><br><span class="line">    <span class="comment">// 用户关注实体的id就是被关注的用户id-&gt;EntityId=EntityUserId</span></span><br><span class="line">    eventProducer.fireEvent(event);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> CommunityUtil.getJSONString(<span class="number">0</span>, <span class="string">&quot;关注成功!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10-3-5-前端核心"><a href="#10-3-5-前端核心" class="headerlink" title="10.3.5 前端核心"></a>10.3.5 前端核心</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 由于关注中多传了一个帖子id属性，因此要在前端加入对应的属性 $&#123;post.<span class="property">id</span>&#125;) --&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:;&quot;</span> <span class="attr">th:onclick</span>=<span class="string">&quot;|like(this,1,$&#123;post.id&#125;,$&#123;post.userId&#125;,$&#123;post.id&#125;);|&quot;</span> <span class="attr">class</span>=<span class="string">&quot;text-primary&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    function like(element, entityType, entityId, entityUserId,postId) &#123;</span></span><br><span class="line"><span class="language-xml">    $.post(</span></span><br><span class="line"><span class="language-xml">      CONTEXT_PATH + &quot;/like&quot;,</span></span><br><span class="line"><span class="language-xml">      &#123;</span></span><br><span class="line"><span class="language-xml">        &quot;entityType&quot;: entityType,</span></span><br><span class="line"><span class="language-xml">        &quot;entityId&quot;: entityId,</span></span><br><span class="line"><span class="language-xml">        &quot;entityUserId&quot;: entityUserId,</span></span><br><span class="line"><span class="language-xml">        &quot;postId&quot;:postId</span></span><br><span class="line"><span class="language-xml">      &#125;,</span></span><br><span class="line"><span class="language-xml">      ...</span></span><br><span class="line"><span class="language-xml">    )&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="10-4-显示系统通知"><a href="#10-4-显示系统通知" class="headerlink" title="10.4 显示系统通知"></a>10.4 显示系统通知</h2><h3 id="10-4-1-Mapper"><a href="#10-4-1-Mapper" class="headerlink" title="10.4.1 Mapper"></a>10.4.1 Mapper</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**查询某个主题最新通知*/</span></span><br><span class="line">Message <span class="title function_">selectLatestNotice</span><span class="params">(<span class="type">int</span> userId, String topic)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 查询某个主题通知个数*/</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">selectNoticeCount</span><span class="params">(<span class="type">int</span> userId, String topic)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 查询某个主题未读个数(topic可为null,若为null:查询所有类系统未读通知个数)*/</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">selectNoticeUnreadCount</span><span class="params">(<span class="type">int</span> userId, String topic)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 分页查询某个主题的详情*/</span></span><br><span class="line">List&lt;Message&gt; <span class="title function_">selectNotices</span><span class="params">(<span class="type">int</span> userId, String topic,<span class="type">int</span> offset,<span class="type">int</span> limit)</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> <span class="operator">&lt;</span><span class="keyword">select</span> id<span class="operator">=</span>&quot;selectLatestNotice&quot; resultType<span class="operator">=</span>&quot;com.dai.community.entity.Message&quot;<span class="operator">&gt;</span></span><br><span class="line">  <span class="keyword">select</span> <span class="operator">&lt;</span>include refid<span class="operator">=</span>&quot;selectFields&quot;<span class="operator">&gt;</span><span class="operator">&lt;</span><span class="operator">/</span>include<span class="operator">&gt;</span> <span class="keyword">from</span> message</span><br><span class="line">  <span class="keyword">where</span> id <span class="keyword">in</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="built_in">max</span>(id) <span class="keyword">from</span> message <span class="keyword">where</span> status <span class="operator">!=</span> <span class="number">2</span> <span class="keyword">and</span> from_id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> to_id <span class="operator">=</span> #&#123;userId&#125; <span class="keyword">and</span> conversation_id<span class="operator">=</span> #&#123;topic&#125;)</span><br><span class="line"><span class="operator">&lt;</span><span class="operator">/</span><span class="keyword">select</span><span class="operator">&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="operator">&lt;</span><span class="keyword">select</span> id<span class="operator">=</span>&quot;selectNoticeCount&quot; resultType<span class="operator">=</span>&quot;java.lang.Integer&quot;<span class="operator">&gt;</span></span><br><span class="line">  <span class="keyword">select</span> <span class="built_in">count</span>(id)</span><br><span class="line">  <span class="keyword">from</span> message</span><br><span class="line">  <span class="keyword">where</span> status <span class="operator">!=</span> <span class="number">2</span> <span class="keyword">and</span> from_id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> to_id <span class="operator">=</span> #&#123;userId&#125; <span class="keyword">and</span> conversation_id <span class="operator">=</span> #&#123;topic&#125;</span><br><span class="line"><span class="operator">&lt;</span><span class="operator">/</span><span class="keyword">select</span><span class="operator">&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="operator">&lt;</span><span class="keyword">select</span> id<span class="operator">=</span>&quot;selectNoticeUnreadCount&quot; resultType<span class="operator">=</span>&quot;java.lang.Integer&quot;<span class="operator">&gt;</span></span><br><span class="line">  <span class="keyword">select</span> <span class="built_in">count</span>(id) <span class="keyword">from</span> message</span><br><span class="line">  <span class="keyword">where</span> status <span class="operator">=</span> <span class="number">0</span> <span class="keyword">and</span> from_id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> to_id <span class="operator">=</span> #&#123;userId&#125;</span><br><span class="line">  <span class="operator">&lt;</span>if test<span class="operator">=</span>&quot;topic!=null&quot;<span class="operator">&gt;</span></span><br><span class="line">    <span class="keyword">and</span> conversation_id <span class="operator">=</span> #&#123;topic&#125;</span><br><span class="line">  <span class="operator">&lt;</span><span class="operator">/</span>if<span class="operator">&gt;</span></span><br><span class="line"><span class="operator">&lt;</span><span class="operator">/</span><span class="keyword">select</span><span class="operator">&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="operator">&lt;</span><span class="keyword">select</span> id<span class="operator">=</span>&quot;selectNotices&quot; resultType<span class="operator">=</span>&quot;com.dai.community.entity.Message&quot;<span class="operator">&gt;</span></span><br><span class="line">  <span class="keyword">select</span></span><br><span class="line">  <span class="operator">&lt;</span>include refid<span class="operator">=</span>&quot;selectFields&quot;<span class="operator">&gt;</span><span class="operator">&lt;</span><span class="operator">/</span>include<span class="operator">&gt;</span></span><br><span class="line">  <span class="keyword">from</span> message</span><br><span class="line">  <span class="keyword">where</span> status <span class="operator">!=</span> <span class="number">2</span> <span class="keyword">and</span> from_id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">and</span> to_id <span class="operator">=</span> #&#123;userId&#125; <span class="keyword">and</span> conversation_id <span class="operator">=</span> #&#123;topic&#125;</span><br><span class="line">  <span class="keyword">order</span> <span class="keyword">by</span> create_time <span class="keyword">desc</span></span><br><span class="line">  limit #&#123;<span class="keyword">offset</span>&#125;, #&#123;limit&#125;</span><br><span class="line"><span class="operator">&lt;</span><span class="operator">/</span><span class="keyword">select</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="10-4-2-Service"><a href="#10-4-2-Service" class="headerlink" title="10.4.2 Service"></a>10.4.2 Service</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Message <span class="title function_">findLatestNotice</span><span class="params">(<span class="type">int</span> userId, String topic)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> messageMapper.selectLatestNotice(userId, topic);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">findNoticeCount</span><span class="params">(<span class="type">int</span> userId, String topic)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> messageMapper.selectNoticeCount(userId, topic);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">findNoticeUnreadCount</span><span class="params">(<span class="type">int</span> userId, String topic)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> messageMapper.selectNoticeUnreadCount(userId, topic);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> List&lt;Message&gt; <span class="title function_">findNotices</span><span class="params">(<span class="type">int</span> userId, String topic, <span class="type">int</span> offset, <span class="type">int</span> limit)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> messageMapper.selectNotices(userId, topic, offset, limit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10-4-3-Controller"><a href="#10-4-3-Controller" class="headerlink" title="10.4.3 Controller"></a>10.4.3 Controller</h3><h4 id="系统通知"><a href="#系统通知" class="headerlink" title="系统通知"></a>系统通知</h4><p>包括 评论类通知、点赞类通知、关注类通知三种类似</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询系统通知</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/notice/list&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getNoticeList</span><span class="params">(Model model)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> hostHolder.getUser();</span><br><span class="line">    <span class="comment">/*查询评论类通知*/</span></span><br><span class="line">    <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> messageService.findLatestNotice(user.getId(), TOPIC_COMMENT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (message != <span class="literal">null</span>) &#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; messageVO = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        messageVO.put(<span class="string">&quot;message&quot;</span>, message);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 转化message表中content为HashMap&lt;k,v&gt;类型*/</span></span><br><span class="line">      </span><br><span class="line">      	<span class="comment">//去掉转义字符</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> HtmlUtils.htmlUnescape(message.getContent());</span><br><span class="line">        Map&lt;String, Object&gt; data = JSONObject.parseObject(content, HashMap.class);</span><br><span class="line">        <span class="comment">// 将content数据中的每一个字段都存入map</span></span><br><span class="line">        <span class="comment">// 用于显示-&gt;用户[user] (评论、点赞、关注[entityType])...了你的(帖子、回复、用户[entityId]) 查看详情连接[postId]</span></span><br><span class="line">        messageVO.put(<span class="string">&quot;user&quot;</span>, userService.findUserById((Integer) data.get(<span class="string">&quot;userId&quot;</span>)));</span><br><span class="line">        messageVO.put(<span class="string">&quot;entityType&quot;</span>, data.get(<span class="string">&quot;entityType&quot;</span>));</span><br><span class="line">        messageVO.put(<span class="string">&quot;entityId&quot;</span>, data.get(<span class="string">&quot;entityId&quot;</span>));</span><br><span class="line">        messageVO.put(<span class="string">&quot;postId&quot;</span>, data.get(<span class="string">&quot;postId&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 共几条会话</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> messageService.findNoticeCount(user.getId(), TOPIC_COMMENT);</span><br><span class="line">        messageVO.put(<span class="string">&quot;count&quot;</span>, count);</span><br><span class="line">        <span class="comment">// 评论类未读数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">unreadCount</span> <span class="operator">=</span> messageService.findNoticeUnreadCount(user.getId(), TOPIC_COMMENT);</span><br><span class="line">        messageVO.put(<span class="string">&quot;unreadCount&quot;</span>, unreadCount);</span><br><span class="line"></span><br><span class="line">        model.addAttribute(<span class="string">&quot;commentNotice&quot;</span>, messageVO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*查询点赞类通知*/</span></span><br><span class="line">    message = messageService.findLatestNotice(user.getId(), TOPIC_LIKE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (message != <span class="literal">null</span>) &#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; messageVO = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        messageVO.put(<span class="string">&quot;message&quot;</span>, message);</span><br><span class="line">        <span class="comment">/* 转化message表中content为HashMap&lt;k,v&gt;类型*/</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> HtmlUtils.htmlUnescape(message.getContent());</span><br><span class="line">        Map&lt;String, Object&gt; data = JSONObject.parseObject(content, HashMap.class);</span><br><span class="line">        <span class="comment">// 将content数据中的每一个字段都存入map</span></span><br><span class="line">        <span class="comment">// 用于显示-&gt;用户[user] (评论、点赞、关注[entityType])...了你的(帖子、回复、用户[entityId]) 查看详情连接[postId]</span></span><br><span class="line">        messageVO.put(<span class="string">&quot;user&quot;</span>, userService.findUserById((Integer) data.get(<span class="string">&quot;userId&quot;</span>)));</span><br><span class="line">        messageVO.put(<span class="string">&quot;entityType&quot;</span>, data.get(<span class="string">&quot;entityType&quot;</span>));</span><br><span class="line">        messageVO.put(<span class="string">&quot;entityId&quot;</span>, data.get(<span class="string">&quot;entityId&quot;</span>));</span><br><span class="line">        messageVO.put(<span class="string">&quot;postId&quot;</span>, data.get(<span class="string">&quot;postId&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 共几条会话</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> messageService.findNoticeCount(user.getId(), TOPIC_LIKE);</span><br><span class="line">        messageVO.put(<span class="string">&quot;count&quot;</span>, count);</span><br><span class="line">        <span class="comment">// 点赞类未读数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">unreadCount</span> <span class="operator">=</span> messageService.findNoticeUnreadCount(user.getId(), TOPIC_LIKE);</span><br><span class="line">        messageVO.put(<span class="string">&quot;unreadCount&quot;</span>, unreadCount);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;likeNotice&quot;</span>, messageVO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*查询关注类通知**/</span></span><br><span class="line">    message = messageService.findLatestNotice(user.getId(), TOPIC_FOLLOW);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (message != <span class="literal">null</span>) &#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; messageVO = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        messageVO.put(<span class="string">&quot;message&quot;</span>, message);</span><br><span class="line">        <span class="comment">/* 转化message表中content为HashMap&lt;k,v&gt;类型*/</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> HtmlUtils.htmlUnescape(message.getContent());</span><br><span class="line">        Map&lt;String, Object&gt; data = JSONObject.parseObject(content, HashMap.class);</span><br><span class="line">        <span class="comment">// 将content数据中的每一个字段都存入map</span></span><br><span class="line">        <span class="comment">// 用于显示-&gt;用户[user] (评论、点赞、关注)...了你的(帖子、回复、用户[entityType]) 查看详情连接[postId]</span></span><br><span class="line">        messageVO.put(<span class="string">&quot;user&quot;</span>, userService.findUserById((Integer) data.get(<span class="string">&quot;userId&quot;</span>)));</span><br><span class="line">        messageVO.put(<span class="string">&quot;entityType&quot;</span>, data.get(<span class="string">&quot;entityType&quot;</span>));</span><br><span class="line">        messageVO.put(<span class="string">&quot;entityId&quot;</span>, data.get(<span class="string">&quot;entityId&quot;</span>));</span><br><span class="line">        messageVO.put(<span class="string">&quot;postId&quot;</span>, data.get(<span class="string">&quot;postId&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 共几条会话</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> messageService.findNoticeCount(user.getId(), TOPIC_FOLLOW);</span><br><span class="line">        messageVO.put(<span class="string">&quot;count&quot;</span>, count);</span><br><span class="line">        <span class="comment">// 关注类未读数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">unreadCount</span> <span class="operator">=</span> messageService.findNoticeUnreadCount(user.getId(), TOPIC_FOLLOW);</span><br><span class="line">        messageVO.put(<span class="string">&quot;unreadCount&quot;</span>, unreadCount);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;followNotice&quot;</span>, messageVO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询未读私信数量</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">letterUnreadCount</span> <span class="operator">=</span> messageService.findLetterUnreadCount(user.getId(), <span class="literal">null</span>);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;letterUnreadCount&quot;</span>, letterUnreadCount);</span><br><span class="line">    <span class="comment">// 查询所有未读系统通知数量</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">noticeUnreadCount</span> <span class="operator">=</span> messageService.findNoticeUnreadCount(user.getId(), <span class="literal">null</span>);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;noticeUnreadCount&quot;</span>, noticeUnreadCount);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/site/notice&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="通知详情"><a href="#通知详情" class="headerlink" title="通知详情"></a>通知详情</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询系统通知详情页（分页）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/notice/detail/&#123;topic&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getNoticeDetail</span><span class="params">(<span class="meta">@PathVariable(&quot;topic&quot;)</span>String topic, Page page, Model model)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> hostHolder.getUser();</span><br><span class="line"></span><br><span class="line">    page.setLimit(<span class="number">5</span>);</span><br><span class="line">    page.setPath(<span class="string">&quot;/notice/detail/&quot;</span> + topic);</span><br><span class="line">    page.setRows(messageService.findNoticeCount(user.getId(), topic));</span><br><span class="line"></span><br><span class="line">    List&lt;Message&gt; noticeList = messageService.findNotices(user.getId(), topic, page.getOffset(), page.getLimit());</span><br><span class="line">    <span class="comment">// 聚合拼接User</span></span><br><span class="line">    List&lt;Map&lt;String, Object&gt;&gt; noticeVoList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (noticeList != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Message notice : noticeList) &#123;</span><br><span class="line">            HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            <span class="comment">// 将查询出来的每一个通知封装Map</span></span><br><span class="line">            map.put(<span class="string">&quot;notice&quot;</span>, notice);</span><br><span class="line">            <span class="comment">// 发起事件的user</span></span><br><span class="line">            map.put(<span class="string">&quot;user&quot;</span>, userService.findUserById(user.getId()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 把message中的content内容转化Object</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> HtmlUtils.htmlUnescape(notice.getContent());</span><br><span class="line">            Map&lt;String, Object&gt; data = JSONObject.parseObject(content, HashMap.class);</span><br><span class="line">            map.put(<span class="string">&quot;entityType&quot;</span>, data.get(<span class="string">&quot;entityType&quot;</span>));</span><br><span class="line">            map.put(<span class="string">&quot;entityId&quot;</span>, data.get(<span class="string">&quot;entityId&quot;</span>));</span><br><span class="line">            map.put(<span class="string">&quot;postId&quot;</span>, data.get(<span class="string">&quot;postId&quot;</span>));</span><br><span class="line">            <span class="comment">// 系统通知-&gt;id=1的系统用户</span></span><br><span class="line">            map.put(<span class="string">&quot;fromUser&quot;</span>, userService.findUserById(notice.getFromId()));</span><br><span class="line"></span><br><span class="line">            noticeVoList.add(map);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    model.addAttribute(<span class="string">&quot;notices&quot;</span>, noticeVoList);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置已读(当打开这个页面是就更改status =1)</span></span><br><span class="line">    List&lt;Integer&gt; ids = getLetterIds(noticeList);</span><br><span class="line">    <span class="keyword">if</span> (!ids.isEmpty()) &#123;</span><br><span class="line">        messageService.readMessage(ids);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/site/notice-detail&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="未读消息总数"><a href="#未读消息总数" class="headerlink" title="未读消息总数"></a>未读消息总数</h4><p>包括未读私信和未读通知</p>
<p><strong>拦截器</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> HostHolder hostHolder;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> MessageService messageService;</span><br><span class="line">  <span class="comment">// 查询未读消息总数(AOP),controller之后，渲染模板之前</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> hostHolder.getUser();</span><br><span class="line">    <span class="keyword">if</span> (user != <span class="literal">null</span> &amp;&amp; modelAndView != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="type">int</span> <span class="variable">letterUnreadCount</span> <span class="operator">=</span> messageService.findLetterUnreadCount(user.getId(), <span class="literal">null</span>);</span><br><span class="line">      <span class="type">int</span> <span class="variable">noticeUnreadCount</span> <span class="operator">=</span> messageService.findNoticeUnreadCount(user.getId(), <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">      modelAndView.addObject(<span class="string">&quot;allUnreadCount&quot;</span>, letterUnreadCount + noticeUnreadCount);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// index页前端对应代码</span></span><br><span class="line">&lt;li th:<span class="keyword">if</span>=<span class="string">&quot;$&#123;loginUser!=null&#125;&quot;</span>&gt;</span><br><span class="line">  &lt;a th:href=<span class="string">&quot;@&#123;/letter/list&#125;&quot;</span>&gt;消息&lt;span th:text=<span class="string">&quot;$&#123;allUnreadCount!=0?allUnreadCount:&#x27;&#x27;&#125;&quot;</span>&gt;消息未读总数&lt;/span&gt;&lt;/a&gt;</span><br><span class="line">&lt;/li&gt;</span><br></pre></td></tr></table></figure>

<p><strong>注册拦截器</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> MessageInterceptor messageInterceptor;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">  registry.addInterceptor(messageInterceptor)</span><br><span class="line">    .excludePathPatterns(<span class="string">&quot;/* */*.css&quot;</span>, <span class="string">&quot;/**/ *.js&quot;</span>, <span class="string">&quot;/* */*.png&quot;</span>, <span class="string">&quot;/ **/ *.jpg&quot;</span>, <span class="string">&quot;/* */*.jpeg&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10-4-4-前端核心"><a href="#10-4-4-前端核心" class="headerlink" title="10.4.4 前端核心"></a>10.4.4 前端核心</h3><h4 id="系统通知页"><a href="#系统通知页" class="headerlink" title="系统通知页"></a>系统通知页</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;active&quot;</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/notice/list&#125;&quot;</span>&gt;</span></span><br><span class="line">    系统通知<span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;noticeUnreadCount&#125;&quot;</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;noticeUnreadCount!=0&#125;&quot;</span>&gt;</span>系统通知未读数<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 通知列表 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;list-unstyled&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--评论类通知--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;commentNotice!=null&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;commentNotice.unreadCount!=0?commentNotice.unreadCount:&#x27;&#x27;&#125;&quot;</span>&gt;</span>评论通知未读数<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;http://xxx.png&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;通知图标&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h6</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>评论<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;#dates.format(commentNotice.message.createTime,&#x27;yyyy-MM-dd HH:mm:ss&#x27;)&#125;&quot;</span>&gt;</span>时间<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">h6</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/notice/detail/comment&#125;&quot;</span>&gt;</span></span><br><span class="line">        用户 <span class="tag">&lt;<span class="name">i</span> <span class="attr">th:utext</span>=<span class="string">&quot;$&#123;commentNotice.user.username&#125;&quot;</span>&gt;</span>评论发起人用户名<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">        评论了你的<span class="tag">&lt;<span class="name">b</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;commentNotice.entityType==1?&#x27;帖子&#x27;:&#x27;回复&#x27;&#125;&quot;</span>&gt;</span>帖子<span class="tag">&lt;/<span class="name">b</span>&gt;</span> ...<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>共 <span class="tag">&lt;<span class="name">i</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;commentNotice.count&#125;&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">i</span>&gt;</span> 条会话<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--点赞类通知--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;likeNotice!=null&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;likeNotice.unreadCount!=0?likeNotice.unreadCount:&#x27;&#x27;&#125;&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;http://like.png&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;通知图标&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h6</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>赞<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;#dates.format(likeNotice.message.createTime,&#x27;yyyy-MM-dd HH:mm:ss&#x27;)&#125;&quot;</span>&gt;</span>时间<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">h6</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/notice/detail/like&#125;&quot;</span>&gt;</span></span><br><span class="line">          用户</span><br><span class="line">          <span class="tag">&lt;<span class="name">i</span> <span class="attr">th:utext</span>=<span class="string">&quot;$&#123;likeNotice.user.username&#125;&quot;</span>&gt;</span>nowcoder<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">          点赞了你的<span class="tag">&lt;<span class="name">b</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;likeNotice.entityType==1?&#x27;帖子&#x27;:&#x27;回复&#x27;&#125;&quot;</span>&gt;</span>帖子<span class="tag">&lt;/<span class="name">b</span>&gt;</span> ...</span><br><span class="line">        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;text-primary&quot;</span>&gt;</span>共 <span class="tag">&lt;<span class="name">i</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;likeNotice.count&#125;&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">i</span>&gt;</span> 条会话<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--关注类通知--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;followNotice!=null&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;followNotice.unreadCount!=0?followNotice.unreadCount:&#x27;&#x27;&#125;&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;http://follow.png&quot;</span> <span class="attr">class</span>=<span class="string">&quot;mr-4 user-header&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;通知图标&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h6</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>关注<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;#dates.format(followNotice.message.createTime,&#x27;yyyy-MM-dd HH:mm:ss&#x27;)&#125;&quot;</span>&gt;</span>时间<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">h6</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/notice/detail/follow&#125;&quot;</span>&gt;</span></span><br><span class="line">          用户</span><br><span class="line">          <span class="tag">&lt;<span class="name">i</span> <span class="attr">th:utext</span>=<span class="string">&quot;$&#123;followNotice.user.username&#125;&quot;</span>&gt;</span>nowcoder<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">          关注了你 ...</span><br><span class="line">        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;text-primary&quot;</span>&gt;</span>共 <span class="tag">&lt;<span class="name">i</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;followNotice.count&#125;&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">i</span>&gt;</span> 条会话<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="通知详情页"><a href="#通知详情页" class="headerlink" title="通知详情页"></a>通知详情页</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-4 text-right&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-secondary btn-sm&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;back();&quot;</span>&gt;</span>返回<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 通知列表 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">th:each</span>=<span class="string">&quot;map:$&#123;notices&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">th:src</span>=<span class="string">&quot;$&#123;map.fromUser.headerUrl&#125;&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;系统图标&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">strong</span> <span class="attr">th:utext</span>=<span class="string">&quot;$&#123;map.fromUser.username&#125;&quot;</span>&gt;</span>系统名<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">small</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;#dates.format(map.notice.createTime,&#x27;yyyy-MM-dd HH:mm:ss&#x27;)&#125;&quot;</span>&gt;</span>时间<span class="tag">&lt;/<span class="name">small</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--显示评论信息--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;topic.equals(&#x27;comment&#x27;)&#125;&quot;</span>&gt;</span></span><br><span class="line">          用户</span><br><span class="line">          <span class="tag">&lt;<span class="name">i</span> <span class="attr">th:utext</span>=<span class="string">&quot;$&#123;map.user.username&#125;&quot;</span>&gt;</span>发起事件人<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">          评论了你的<span class="tag">&lt;<span class="name">b</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;map.entityType==1?&#x27;帖子&#x27;:&#x27;回复&#x27;&#125;&quot;</span>&gt;</span>帖子<span class="tag">&lt;/<span class="name">b</span>&gt;</span>,</span><br><span class="line">          <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;|/discuss/detail/$&#123;map.postId&#125;|&#125;&quot;</span>&gt;</span>点击查看<span class="tag">&lt;/<span class="name">a</span>&gt;</span> !</span><br><span class="line">        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--显示点赞信息--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;topic.equals(&#x27;like&#x27;)&#125;&quot;</span>&gt;</span></span><br><span class="line">          用户</span><br><span class="line">          <span class="tag">&lt;<span class="name">i</span> <span class="attr">th:utext</span>=<span class="string">&quot;$&#123;map.user.username&#125;&quot;</span>&gt;</span>发起事件人<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">          点赞了你的<span class="tag">&lt;<span class="name">b</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;map.entityType==1?&#x27;帖子&#x27;:&#x27;回复&#x27;&#125;&quot;</span>&gt;</span>帖子<span class="tag">&lt;/<span class="name">b</span>&gt;</span>,</span><br><span class="line">          <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;|/discuss/detail/$&#123;map.postId&#125;|&#125;&quot;</span>&gt;</span>点击查看<span class="tag">&lt;/<span class="name">a</span>&gt;</span> !</span><br><span class="line">        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--显示关注信息--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;topic.equals(&#x27;follow&#x27;)&#125;&quot;</span>&gt;</span></span><br><span class="line">          用户</span><br><span class="line">          <span class="tag">&lt;<span class="name">i</span> <span class="attr">th:utext</span>=<span class="string">&quot;$&#123;map.user.username&#125;&quot;</span>&gt;</span>发起事件人<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">          关注了你,</span><br><span class="line">          <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;|/user/profile/$&#123;map.user.id&#125;|&#125;&quot;</span>&gt;</span>点击查看<span class="tag">&lt;/<span class="name">a</span>&gt;</span> !</span><br><span class="line">        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">back</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    location.<span class="property">href</span> = <span class="variable constant_">CONTEXT_PATH</span> + <span class="string">&quot;/notice/list&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="10-4-5-issue"><a href="#10-4-5-issue" class="headerlink" title="10.4.5 issue"></a>10.4.5 issue</h3><p>发表完评论无法重定向回当前页【重定向失效】</p>
<p>解决：在添加评论的方法上多加了@ResponseBody导致springMVC直接返回字符，因此去除即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/add/&#123;discussPostId&#125;&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">addComment</span><span class="params">(<span class="meta">@PathVariable(&quot;discussPostId&quot;)</span> <span class="type">int</span> discussPostId, Comment comment)</span> &#123;</span><br><span class="line">  comment.setUserId(hostHolder.getUser().getId());</span><br><span class="line">  comment.setStatus(<span class="number">0</span>);</span><br><span class="line">  comment.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">  commentService.addComment(comment);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;redirect:/discuss/detail/&quot;</span> + discussPostId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/image-20220810144556126.png" alt="image-20220810144556126"></p>
<h1 id="11-搜索功能"><a href="#11-搜索功能" class="headerlink" title="11. 搜索功能"></a>11. 搜索功能</h1><h2 id="11-1-整合Elasticsearch"><a href="#11-1-整合Elasticsearch" class="headerlink" title="11.1 整合Elasticsearch"></a>11.1 整合Elasticsearch</h2><p><strong>相关术语</strong></p>
<ul>
<li><p>和mysql类比</p>
<ul>
<li>索引：数据库，database，6.0以后变化，对应表</li>
<li>类型：table，6.0以后变化，废弃</li>
<li>文档：一张表里的一行</li>
<li>字段：一个属性就是一个字段</li>
</ul>
</li>
<li><p>和分布式相关</p>
<ul>
<li>集群：分布式部署</li>
<li>节点：每一台服务器</li>
<li>分片：对索引进一步的划分</li>
<li>副本：对分片的备份</li>
</ul>
</li>
</ul>
<h3 id="11-1-1-配置文件"><a href="#11-1-1-配置文件" class="headerlink" title="11.1.1 配置文件"></a>11.1.1 配置文件</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.elasticsearch.cluster-name</span>=<span class="string">dai</span></span><br><span class="line"><span class="attr">spring.elasticsearch.rest.uris</span>=<span class="string">127.0.0.1:9200</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommunityApplication</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// 解决netty启动冲突问题</span></span><br><span class="line">    System.setProperty(<span class="string">&quot;es.set.netty.runtime.available.processors&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">    SpringApplication.run(CommunityApplication.class, args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="11-1-2-实体"><a href="#11-1-2-实体" class="headerlink" title="11.1.2 实体"></a>11.1.2 实体</h3><p>实体类映射到Elasticsearch</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Document(indexName = &quot;discusspost&quot;, shards = 6, replicas = 3)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DiscussPost</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Elaticsearch与数据库表映射</span></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Integer)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> userId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// analyzer = &quot;ik_max_word&quot;：最大中文分词解析器, 存储策略，尽量把这句话拆分成尽量多的单词，增加搜索范围，</span></span><br><span class="line">    <span class="comment">// ik_smart：智能中文分词解析器</span></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;, searchAnalyzer = &quot;ik_smart&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;, searchAnalyzer = &quot;ik_smart&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Integer)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> type;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Integer)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> status;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Date)</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Integer)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> commentCount;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Double)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> score;</span><br></pre></td></tr></table></figure>

<h3 id="11-1-3-Repository"><a href="#11-1-3-Repository" class="headerlink" title="11.1.3 Repository"></a>11.1.3 Repository</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 类似mybatisPlus，在Repository可以做Elasticsearch的相关数据的增删改查 */</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DiscussPostRepository</span> <span class="keyword">extends</span> <span class="title class_">ElasticsearchRepository</span>&lt;DiscussPost, Integer&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="11-1-4-测试"><a href="#11-1-4-测试" class="headerlink" title="11.1.4 测试"></a>11.1.4 测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/************************测试增删改********************************/</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@ContextConfiguration(classes = CommunityApplication.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticsearchTest</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  DiscussPostMapper discussPostMapper;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  DiscussPostRepository discussPostRepository;</span><br><span class="line">  <span class="comment">/** 7版本使用ElasticsearchTemplate会启动报错，使用ElasticsearchRestTemplate */</span></span><br><span class="line">  <span class="meta">@Resource</span></span><br><span class="line">  ElasticsearchRestTemplate elasticsearchRestTemplate;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testInsert</span><span class="params">()</span> &#123;</span><br><span class="line">    discussPostRepository.save(discussPostMapper.selectDiscussPostById(<span class="number">241</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testInsertList</span><span class="params">()</span> &#123;</span><br><span class="line">    discussPostRepository.saveAll(discussPostMapper.selectDiscussPosts(<span class="number">101</span>, <span class="number">0</span>, <span class="number">100</span>));</span><br><span class="line">    discussPostRepository.saveAll(discussPostMapper.selectDiscussPosts(<span class="number">102</span>, <span class="number">0</span>, <span class="number">100</span>));</span><br><span class="line">    discussPostRepository.saveAll(discussPostMapper.selectDiscussPosts(<span class="number">103</span>, <span class="number">0</span>, <span class="number">100</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUpdate</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">DiscussPost</span> <span class="variable">post</span> <span class="operator">=</span> discussPostMapper.selectDiscussPostById(<span class="number">231</span>);</span><br><span class="line">    post.setContent(<span class="string">&quot;我是新人,使劲灌水.&quot;</span>);</span><br><span class="line">    discussPostRepository.save(post);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDelete</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// discussRepository.deleteById(231);</span></span><br><span class="line">    discussPostRepository.deleteAll();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// localhost:9200/post/_search   get请求 接口查询所有</span></span><br><span class="line"><span class="comment">// localhost:9200/post/_doc/231  get请求 接口查询某一条</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">/************************测试搜索********************************/</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSearchByRepository</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">NativeSearchQuery</span> <span class="variable">search</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NativeSearchQueryBuilder</span>()</span><br><span class="line">        <span class="comment">//构建搜索条件:关键字既从title中搜，又从content中搜</span></span><br><span class="line">        .withQuery(QueryBuilders.multiMatchQuery(<span class="string">&quot;互联网寒冬&quot;</span>, <span class="string">&quot;title&quot;</span>, <span class="string">&quot;content&quot;</span>))</span><br><span class="line">        <span class="comment">//排序优先级别type--score--createTime</span></span><br><span class="line">        .withSorts(</span><br><span class="line">            SortBuilders.fieldSort(<span class="string">&quot;type&quot;</span>).order(SortOrder.DESC),</span><br><span class="line">            SortBuilders.fieldSort(<span class="string">&quot;score&quot;</span>).order(SortOrder.DESC),</span><br><span class="line">            SortBuilders.fieldSort(<span class="string">&quot;createTime&quot;</span>).order(SortOrder.DESC)</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">//分页</span></span><br><span class="line">        .withPageable(PageRequest.of(<span class="number">0</span>, <span class="number">10</span>))</span><br><span class="line">        <span class="comment">//高亮显示字段</span></span><br><span class="line">        .withHighlightFields(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">HighlightBuilder</span>.Field(<span class="string">&quot;title&quot;</span>).preTags(<span class="string">&quot;&lt;em&gt;&quot;</span>).postTags(<span class="string">&quot;&lt;/em&gt;&quot;</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">HighlightBuilder</span>.Field(<span class="string">&quot;content&quot;</span>).preTags(<span class="string">&quot;&lt;em&gt;&quot;</span>).postTags(<span class="string">&quot;&lt;/em&gt;&quot;</span>)</span><br><span class="line">        ).build();</span><br><span class="line">    SearchHits&lt;DiscussPost&gt; hits = elasticsearchRestTemplate.search(search, DiscussPost.class);</span><br><span class="line">    <span class="keyword">if</span> (hits.getTotalHits() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    hits.forEach(System.out::println);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="11-2-Service（高亮搜索）"><a href="#11-2-Service（高亮搜索）" class="headerlink" title="11.2 Service（高亮搜索）"></a>11.2 Service（高亮搜索）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用Elasticsearch服务器搜索帖子service</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticsearchService</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> DiscussPostRepository discussRepository;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> ElasticsearchTemplate elasticTemplate;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveDiscussPost</span><span class="params">(DiscussPost post)</span> &#123;</span><br><span class="line">    discussRepository.save(post);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteDiscussPost</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">    discussRepository.deleteById(id);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Elasticsearch高亮搜索</span></span><br><span class="line"><span class="comment">     * current：当前页（不是offset起始页）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="keyword">public</span> Page&lt;DiscussPost&gt; <span class="title function_">searchDiscussPost</span><span class="params">(String keyword, <span class="type">int</span> current, <span class="type">int</span> limit)</span> &#123;</span><br><span class="line">    <span class="type">SearchQuery</span> <span class="variable">searchQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NativeSearchQueryBuilder</span>()</span><br><span class="line">      .withQuery(QueryBuilders.multiMatchQuery(keyword, <span class="string">&quot;title&quot;</span>, <span class="string">&quot;content&quot;</span>))</span><br><span class="line">      .withSort(SortBuilders.fieldSort(<span class="string">&quot;type&quot;</span>).order(SortOrder.DESC))</span><br><span class="line">      .withSort(SortBuilders.fieldSort(<span class="string">&quot;score&quot;</span>).order(SortOrder.DESC))</span><br><span class="line">      .withSort(SortBuilders.fieldSort(<span class="string">&quot;createTime&quot;</span>).order(SortOrder.DESC))</span><br><span class="line">      .withPageable(PageRequest.of(current, limit))</span><br><span class="line">      .withHighlightFields(</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">HighlightBuilder</span>.Field(<span class="string">&quot;title&quot;</span>).preTags(<span class="string">&quot;&lt;em&gt;&quot;</span>).postTags(<span class="string">&quot;&lt;/em&gt;&quot;</span>),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">HighlightBuilder</span>.Field(<span class="string">&quot;content&quot;</span>).preTags(<span class="string">&quot;&lt;em&gt;&quot;</span>).postTags(<span class="string">&quot;&lt;/em&gt;&quot;</span>)</span><br><span class="line">    ).build();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// new SearchResultMapper()匿名类，处理高亮</span></span><br><span class="line">    <span class="keyword">return</span> elasticTemplate.queryForPage(searchQuery, DiscussPost.class, <span class="keyword">new</span> <span class="title class_">SearchResultMapper</span>() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> &lt;T&gt; AggregatedPage&lt;T&gt; <span class="title function_">mapResults</span><span class="params">(SearchResponse response, Class&lt;T&gt; aClass, Pageable pageable)</span> &#123;</span><br><span class="line">        <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> response.getHits();</span><br><span class="line">        <span class="keyword">if</span> (hits.getTotalHits() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;DiscussPost&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">          <span class="type">DiscussPost</span> <span class="variable">post</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DiscussPost</span>();</span><br><span class="line"></span><br><span class="line">          <span class="comment">// elasticsearch中将json格式数据封装为了map,在将map字段存进post中</span></span><br><span class="line">          <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> hit.getSourceAsMap().get(<span class="string">&quot;id&quot;</span>).toString();</span><br><span class="line">          post.setId(Integer.valueOf(id));</span><br><span class="line"></span><br><span class="line">          <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> hit.getSourceAsMap().get(<span class="string">&quot;userId&quot;</span>).toString();</span><br><span class="line">          post.setUserId(Integer.valueOf(userId));</span><br><span class="line"></span><br><span class="line">          <span class="type">String</span> <span class="variable">title</span> <span class="operator">=</span> hit.getSourceAsMap().get(<span class="string">&quot;title&quot;</span>).toString();</span><br><span class="line">          post.setTitle(title);</span><br><span class="line"></span><br><span class="line">          <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> hit.getSourceAsMap().get(<span class="string">&quot;content&quot;</span>).toString();</span><br><span class="line">          post.setContent(content);</span><br><span class="line"></span><br><span class="line">          <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> hit.getSourceAsMap().get(<span class="string">&quot;status&quot;</span>).toString();</span><br><span class="line">          post.setStatus(Integer.valueOf(status));</span><br><span class="line"></span><br><span class="line">          <span class="comment">// createTime字符串是Long类型</span></span><br><span class="line">          <span class="type">String</span> <span class="variable">createTime</span> <span class="operator">=</span> hit.getSourceAsMap().get(<span class="string">&quot;createTime&quot;</span>).toString();</span><br><span class="line">          post.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>(Long.valueOf(createTime)));</span><br><span class="line"></span><br><span class="line">          <span class="type">String</span> <span class="variable">commentCount</span> <span class="operator">=</span> hit.getSourceAsMap().get(<span class="string">&quot;commentCount&quot;</span>).toString();</span><br><span class="line">          post.setCommentCount(Integer.valueOf(commentCount));</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 处理高亮显示的结果</span></span><br><span class="line">          <span class="type">HighlightField</span> <span class="variable">titleField</span> <span class="operator">=</span> hit.getHighlightFields().get(<span class="string">&quot;title&quot;</span>);</span><br><span class="line">          <span class="keyword">if</span> (titleField != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// [0]-&gt;搜寻结果为多段时，取第一段</span></span><br><span class="line">            post.setTitle(titleField.getFragments()[<span class="number">0</span>].toString());</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="type">HighlightField</span> <span class="variable">contentField</span> <span class="operator">=</span> hit.getHighlightFields().get(<span class="string">&quot;content&quot;</span>);</span><br><span class="line">          <span class="keyword">if</span> (contentField != <span class="literal">null</span>) &#123;</span><br><span class="line">            post.setContent(contentField.getFragments()[<span class="number">0</span>].toString());</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          list.add(post);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AggregatedPageImpl</span>(list, pageable,</span><br><span class="line">                                      hits.getTotalHits(), response.getAggregations(), response.getScrollId(), hits.getMaxScore());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">************************************************************************************************************</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Service</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticsearchService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DiscussPostRepository discussRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    ElasticsearchRestTemplate template;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveDiscussPost</span><span class="params">(DiscussPost post)</span> &#123;</span><br><span class="line">      discussRepository.save(post);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteDiscussPost</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">      discussRepository.deleteById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Page&lt;DiscussPost&gt; <span class="title function_">searchDiscussPost</span><span class="params">(String keyword, <span class="type">int</span> current, <span class="type">int</span> limit)</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="type">Pageable</span> <span class="variable">pageable</span> <span class="operator">=</span> PageRequest.of(current, limit);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//设置需要高亮的字段</span></span><br><span class="line">      HighlightBuilder.<span class="type">Field</span> <span class="variable">title</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HighlightBuilder</span>.Field(<span class="string">&quot;title&quot;</span>).preTags(<span class="string">&quot;&lt;em&gt;&quot;</span>).postTags(<span class="string">&quot;&lt;/em&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">      HighlightBuilder.<span class="type">Field</span> <span class="variable">content</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HighlightBuilder</span>.Field(<span class="string">&quot;content&quot;</span>).preTags(<span class="string">&quot;&lt;em&gt;&quot;</span>).postTags(<span class="string">&quot;&lt;/em&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="type">NativeSearchQuery</span> <span class="variable">search</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NativeSearchQueryBuilder</span>()</span><br><span class="line">        <span class="comment">//构建搜索条件</span></span><br><span class="line">        .withQuery(QueryBuilders.multiMatchQuery(keyword, <span class="string">&quot;title&quot;</span>, <span class="string">&quot;content&quot;</span>))</span><br><span class="line">        <span class="comment">//排序优先级别type--score--createTime</span></span><br><span class="line">        .withSorts(</span><br><span class="line">        SortBuilders.fieldSort(<span class="string">&quot;type&quot;</span>).order(SortOrder.DESC),</span><br><span class="line">        SortBuilders.fieldSort(<span class="string">&quot;score&quot;</span>).order(SortOrder.DESC),</span><br><span class="line">        SortBuilders.fieldSort(<span class="string">&quot;createTime&quot;</span>).order(SortOrder.DESC)</span><br><span class="line">      )</span><br><span class="line">        .withPageable(pageable)</span><br><span class="line">        .withHighlightFields(title,content)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">      SearchHits&lt;DiscussPost&gt; hits = template.search(search, DiscussPost.class);</span><br><span class="line"></span><br><span class="line">      <span class="type">long</span> <span class="variable">totalHits</span> <span class="operator">=</span> hits.getTotalHits();</span><br><span class="line">      <span class="keyword">if</span> (totalHits &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      ArrayList&lt;Object&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 遍历获取搜索到的数据</span></span><br><span class="line">      <span class="keyword">for</span> (SearchHit&lt;DiscussPost&gt; hit : hits) &#123;</span><br><span class="line">        <span class="type">DiscussPost</span> <span class="variable">hitContent</span> <span class="operator">=</span> hit.getContent();</span><br><span class="line">        <span class="comment">// 处理高亮</span></span><br><span class="line">        Map&lt;String, List&lt;String&gt;&gt; highlightFields = hit.getHighlightFields();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, List&lt;String&gt;&gt; stringHighlightFieldEntry : highlightFields.entrySet()) &#123;</span><br><span class="line"></span><br><span class="line">          <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> stringHighlightFieldEntry.getKey();</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (StringUtils.equals(key, <span class="string">&quot;title&quot;</span>)) &#123;</span><br><span class="line">            List&lt;String&gt; fragments = stringHighlightFieldEntry.getValue();</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            <span class="keyword">for</span> (String fragment : fragments) &#123;</span><br><span class="line">              sb.append(fragment);</span><br><span class="line">            &#125;</span><br><span class="line">            hitContent.setTitle(sb.toString());</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (StringUtils.equals(key, <span class="string">&quot;content&quot;</span>)) &#123;</span><br><span class="line">            List&lt;String&gt; fragments = stringHighlightFieldEntry.getValue();</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            <span class="keyword">for</span> (String fragment : fragments) &#123;</span><br><span class="line">              sb.append(fragment);</span><br><span class="line">            &#125;</span><br><span class="line">            hitContent.setContent(sb.toString());</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        list.add(hitContent);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageImpl</span>(list, pageable, totalHits);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="11-3-消费者添加方法"><a href="#11-3-消费者添加方法" class="headerlink" title="11.3 消费者添加方法"></a>11.3 消费者添加方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消费帖子发布事件，将新增的帖子和添加评论后帖子评论数通过消息队列的方式save进Elastisearch服务器中</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@KafkaListener(topics = &#123;TOPIC_PUBILISH&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDiscussPostMessage</span><span class="params">(ConsumerRecord record)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (record == <span class="literal">null</span> || record.value() == <span class="literal">null</span>) &#123;</span><br><span class="line">    logger.error(<span class="string">&quot;消息的内容为空!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 将record.value字符串格式转化为Event对象</span></span><br><span class="line">  <span class="type">Event</span> <span class="variable">event</span> <span class="operator">=</span> JSONObject.parseObject(record.value().toString(), Event.class);</span><br><span class="line">  <span class="comment">// 注意：event若data=null,是fastjson依赖版本的问题</span></span><br><span class="line">  <span class="keyword">if</span> (event == <span class="literal">null</span>) &#123;</span><br><span class="line">    logger.error(<span class="string">&quot;消息格式错误!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">DiscussPost</span> <span class="variable">post</span> <span class="operator">=</span> discussPostService.findDiscussPostById(event.getEntityId());</span><br><span class="line">  elasticsearchService.saveDiscussPost(post);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="11-4-Controller"><a href="#11-4-Controller" class="headerlink" title="11.4 Controller"></a>11.4 Controller</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//**************************增加常量*******************************</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Kafka主题: 发布帖子(常量接口)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">String</span> <span class="variable">TOPIC_PUBILISH</span> <span class="operator">=</span> <span class="string">&quot;publish&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//******************修改CommentController*************************</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/add/&#123;discussPostId&#125;&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">addComment</span><span class="params">(<span class="meta">@PathVariable(&quot;discussPostId&quot;)</span> <span class="type">int</span> discussPostId, Comment comment)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * 增加评论时，将帖子异步提交到Elasticsearch服务器</span></span><br><span class="line"><span class="comment">   * 通过Kafka消息队列去提交，修改Elasticsearch中帖子的评论数</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">//若评论为帖子类型时，才需要加入消息队列处理</span></span><br><span class="line">  <span class="keyword">if</span> (comment.getEntityType() == ENTITY_TYPE_POST) &#123;</span><br><span class="line">    event = <span class="keyword">new</span> <span class="title class_">Event</span>()</span><br><span class="line">      .setTopic(TOPIC_PUBLISH)</span><br><span class="line">      .setUserId(comment.getUserId())</span><br><span class="line">      .setEntityType(ENTITY_TYPE_POST)</span><br><span class="line">      .setEntityId(discussPostId);</span><br><span class="line">    eventProducer.fireEvent(event);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;redirect:/discuss/detail/&quot;</span> + discussPostId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//******************修改DiscusspostController*************************</span></span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;/add&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">addDiscussPost</span><span class="params">(String title, String content)</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//.....</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * 发布帖子时，将帖子异步提交到Elasticsearch服务器</span></span><br><span class="line"><span class="comment">   * 通过Kafka消息队列去提交，将新发布的帖子存入Elasticsearch</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="type">Event</span> <span class="variable">event</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Event</span>()</span><br><span class="line">    .setTopic(TOPIC_PUBLISH)</span><br><span class="line">    .setUserId(user.getId())</span><br><span class="line">    .setEntityType(ENTITY_TYPE_POST)</span><br><span class="line">    .setEntityId(post.getId());</span><br><span class="line">  eventProducer.fireEvent(event);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//返回Json格式字符串给前端JS,报错的情况将来统一处理</span></span><br><span class="line">  <span class="keyword">return</span> CommunityUtil.getJSONString(<span class="number">0</span>, <span class="string">&quot;发布成功！&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="11-5-前端核心"><a href="#11-5-前端核心" class="headerlink" title="11.5 前端核心"></a>11.5 前端核心</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- -----------------------------index------------------------ --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 搜索表单 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;get&quot;</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/search&#125;&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--th:value-&gt;设置默认值  model.addAttribute(&quot;keyword&quot;, keyword) --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;search&quot;</span> <span class="attr">aria-label</span>=<span class="string">&quot;Search&quot;</span> <span class="attr">name</span>=<span class="string">&quot;keyword&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;keyword&#125;&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>搜索<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- -----------------------------search------------------------ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">th:each</span>=<span class="string">&quot;map:$&#123;discussPosts&#125;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">th:src</span>=<span class="string">&quot;$&#123;map.user.headerUrl&#125;&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;用户头像&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:50px;height:50px&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;|/discuss/detail/$&#123;map.post.id&#125;|&#125;&quot;</span> <span class="attr">th:utext</span>=<span class="string">&quot;$&#123;map.post.title&#125;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">em</span>&gt;</span>搜索词高亮显示<span class="tag">&lt;/<span class="name">em</span>&gt;</span>可链接的帖子标题<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">th:utext</span>=<span class="string">&quot;$&#123;map.post.content&#125;&quot;</span>&gt;</span>帖子内容<span class="tag">&lt;<span class="name">em</span>&gt;</span>搜索词高亮显示<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">u</span> <span class="attr">th:utext</span>=<span class="string">&quot;$&#123;map.user.username&#125;&quot;</span>&gt;</span>作者<span class="tag">&lt;/<span class="name">u</span>&gt;</span>发布于 </span><br><span class="line">      <span class="tag">&lt;<span class="name">b</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;#dates.format(map.post.createTime,&#x27;yyyy-MM-dd HH:mm:ss&#x27;)&#125;&quot;</span>&gt;</span>时间<span class="tag">&lt;/<span class="name">b</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>赞 <span class="tag">&lt;<span class="name">i</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;map.likeCount&#125;&quot;</span>&gt;</span>11<span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>回复 <span class="tag">&lt;<span class="name">i</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;map.post.commentCount&#125;&quot;</span>&gt;</span>7<span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">复用分页</span><br></pre></td></tr></table></figure>

<h1 id=""><a href="#" class="headerlink" title=""></a></h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/10/%E7%82%B9%E8%B5%9E%E5%8F%8A%E5%85%B3%E6%B3%A8%E6%A8%A1%E5%9D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Daiiiiiiiiiii">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小戴的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/10/%E7%82%B9%E8%B5%9E%E5%8F%8A%E5%85%B3%E6%B3%A8%E6%A8%A1%E5%9D%97/" class="post-title-link" itemprop="url">点赞及关注模块</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-09-10 13:02:00 / 修改时间：13:02:55" itemprop="dateCreated datePublished" datetime="2022-09-10T13:02:00+08:00">2022-09-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">项目笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="7-点赞功能"><a href="#7-点赞功能" class="headerlink" title="7. 点赞功能"></a>7. 点赞功能</h1><h2 id="7-1-整合Redis"><a href="#7-1-整合Redis" class="headerlink" title="7.1 整合Redis"></a>7.1 整合Redis</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认16个库随便选</span></span><br><span class="line"><span class="attr">spring.redis.database</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">spring.redis.host</span>=<span class="string">localhost</span></span><br><span class="line"><span class="attr">spring.redis.port</span>=<span class="string">6379</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// @Resource 不加报编译时错：Could not autowire. No beans of &#x27;RedisConnectionFactory&#x27; type found.  运行没问题</span></span><br><span class="line">  <span class="meta">@Resource</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory factory)</span> &#123;</span><br><span class="line">    RedisTemplate&lt;String, Object&gt; template = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">    template.setConnectionFactory(factory);</span><br><span class="line">    <span class="comment">// 设置key的序列化方式</span></span><br><span class="line">    template.setKeySerializer(RedisSerializer.string());</span><br><span class="line">    <span class="comment">// 设置value的序列化方式</span></span><br><span class="line">    template.setValueSerializer(RedisSerializer.json());</span><br><span class="line">    <span class="comment">// 设置hash的key的序列化方式</span></span><br><span class="line">    template.setHashKeySerializer(RedisSerializer.string());</span><br><span class="line">    <span class="comment">// 设置hash的value的序列化方式</span></span><br><span class="line">    template.setHashValueSerializer(RedisSerializer.json());</span><br><span class="line">    <span class="comment">//触发生效</span></span><br><span class="line">    template.afterPropertiesSet();</span><br><span class="line">    <span class="keyword">return</span> template;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-2-点赞、取消赞"><a href="#7-2-点赞、取消赞" class="headerlink" title="7.2 点赞、取消赞"></a>7.2 点赞、取消赞</h2><h3 id="7-2-1-工具类"><a href="#7-2-1-工具类" class="headerlink" title="7.2.1 工具类"></a>7.2.1 工具类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dai.community.Util;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * description: 生成redis的key====&gt;拼装而成的【set集合】</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisKeyUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SPLIT</span> <span class="operator">=</span> <span class="string">&quot;:&quot;</span>;</span><br><span class="line">  <span class="comment">/**实体【评论、帖子】的key的前缀*/</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PREFIX_ENTITY_LIKE</span> <span class="operator">=</span> <span class="string">&quot;like:entity&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 某个实体的赞的【key】 ====&gt;【 like:entity:entityType:entityId 】==key所对应的值==&gt;【 set(userId) 】</span></span><br><span class="line"><span class="comment">   在key中存入userId便于后续开发：查看谁点赞</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getEntityLikeKey</span><span class="params">(<span class="type">int</span> entityType, <span class="type">int</span> entityId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> PREFIX_ENTITY_LIKE + SPLIT + entityType + SPLIT + entityId;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-2-Service"><a href="#7-2-2-Service" class="headerlink" title="7.2.2 Service"></a>7.2.2 Service</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LikeService</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 点赞 set集合===&gt;存储谁给某个实体点的赞</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">like</span><span class="params">(<span class="type">int</span> userId, <span class="type">int</span> entityType, <span class="type">int</span> entityId)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">entityLikeKey</span> <span class="operator">=</span> RedisKeyUtil.getEntityLikeKey(entityType, entityId);</span><br><span class="line">    <span class="comment">// 判断 key集合中是否有userId</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isMember</span> <span class="operator">=</span> redisTemplate.opsForSet().isMember(entityLikeKey, userId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isMember) &#123;</span><br><span class="line">      <span class="comment">// 已被点赞：将userId从key中移除</span></span><br><span class="line">      redisTemplate.opsForSet().remove(entityLikeKey, userId);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      redisTemplate.opsForSet().add(entityLikeKey, userId);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 查询某实体(帖子、留言)点赞的数量</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">findEntItyLikeCount</span><span class="params">(<span class="type">int</span> entityType, <span class="type">int</span> entityId)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">entityLikeKey</span> <span class="operator">=</span> RedisKeyUtil.getEntityLikeKey(entityType, entityId);</span><br><span class="line">    <span class="keyword">return</span> redisTemplate.opsForSet().size(entityLikeKey);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 查询某人对某实体的点赞状态</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">findEntityLikeStatus</span><span class="params">(<span class="type">int</span> userId, <span class="type">int</span> entityType, <span class="type">int</span> entityId)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">entityLikeKey</span> <span class="operator">=</span> RedisKeyUtil.getEntityLikeKey(entityType, entityId);</span><br><span class="line">    <span class="comment">// 1已点赞 0未点赞</span></span><br><span class="line">    <span class="keyword">return</span> redisTemplate.opsForSet().isMember(entityLikeKey, userId) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="7-2-3-Controller"><a href="#7-2-3-Controller" class="headerlink" title="7.2.3 Controller"></a>7.2.3 Controller</h3><p><strong>点赞实现</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LikeController</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  LikeService likeService;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  HostHolder hostHolder;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@RequestMapping(value = &quot;like&quot;, method = RequestMethod.POST)</span></span><br><span class="line">  <span class="meta">@ResponseBody</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">like</span><span class="params">(<span class="type">int</span> entityType, <span class="type">int</span> entityId)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> hostHolder.getUser();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//点赞</span></span><br><span class="line">    likeService.like(user.getId(), entityType, entityId);</span><br><span class="line">    <span class="comment">// 数量</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">likeCount</span> <span class="operator">=</span> likeService.findEntityLikeCount(entityType, entityId);</span><br><span class="line">    <span class="comment">// 状态</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">likeStatus</span> <span class="operator">=</span> likeService.findEntityLikeStatus(user.getId(), entityType, entityId);</span><br><span class="line"></span><br><span class="line">    HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;likeCount&quot;</span>, likeCount);</span><br><span class="line">    map.put(<span class="string">&quot;likeStatus&quot;</span>, likeStatus);</span><br><span class="line">    <span class="keyword">return</span> CommunityUtil.getJSONString(<span class="number">0</span>, <span class="literal">null</span>, map);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>点赞显示</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//========== HomeController 首页=============</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">LikeService likeService;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getIndexPage</span><span class="params">(Model model, Page page)</span> &#123;</span><br><span class="line">  <span class="comment">//查询帖子点赞信息</span></span><br><span class="line">  <span class="type">long</span> <span class="variable">likeCount</span> <span class="operator">=</span> likeService.findEntityLikeCount(ENTITY_TYPE_POST, post.getId());</span><br><span class="line">  map.put(<span class="string">&quot;likeCount&quot;</span>, likeCount);</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line">&lt;li&gt; 赞 &lt;span th:text=<span class="string">&quot;$&#123;map.likeCount&#125;&quot;</span>&gt;<span class="number">11</span>&lt;/span&gt;&lt;/li&gt;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//========== DiscussPostController 详情页=============</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//帖子</span></span><br><span class="line">  <span class="type">long</span> <span class="variable">likeCount</span> <span class="operator">=</span> likeService.findEntityLikeCount(ENTITY_TYPE_POST, post.getId());</span><br><span class="line">model.addAttribute(<span class="string">&quot;likeCount&quot;</span>, likeCount);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="variable">likeStatus</span> <span class="operator">=</span> hostHolder.getUser() == <span class="literal">null</span> ? <span class="number">0</span> :</span><br><span class="line">likeService.findEntityLikeStatus(hostHolder.getUser().getId(), ENTITY_TYPE_POST, post.getId());</span><br><span class="line">model.addAttribute(<span class="string">&quot;likeStatus&quot;</span>, likeStatus);</span><br><span class="line"></span><br><span class="line"><span class="comment">//评论</span></span><br><span class="line">likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_COMMENT, comment.getId());</span><br><span class="line">commentVo.put(<span class="string">&quot;likeCount&quot;</span>, likeCount);</span><br><span class="line"></span><br><span class="line">likeStatus = hostHolder.getUser() == <span class="literal">null</span> ? <span class="number">0</span> :</span><br><span class="line">likeService.findEntityLikeStatus(hostHolder.getUser().getId(),ENTITY_TYPE_COMMENT, comment.getId());</span><br><span class="line">commentVo.put(<span class="string">&quot;likeStatus&quot;</span>, likeStatus);</span><br><span class="line"></span><br><span class="line"><span class="comment">//回复</span></span><br><span class="line">likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_COMMENT, reply.getId());</span><br><span class="line">replyVo.put(<span class="string">&quot;likeCount&quot;</span>, likeCount);</span><br><span class="line"></span><br><span class="line">likeStatus = hostHolder.getUser() == <span class="literal">null</span> ? <span class="number">0</span> :</span><br><span class="line">likeService.findEntityLikeStatus(hostHolder.getUser().getId(), ENTITY_TYPE_COMMENT, reply.getId());</span><br><span class="line">replyVo.put(<span class="string">&quot;likeStatus&quot;</span>, likeStatus);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="7-2-4-前端核心"><a href="#7-2-4-前端核心" class="headerlink" title="7.2.4 前端核心"></a>7.2.4 前端核心</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * element: 当前节点 entityType:实体类型（1帖子，2评论[回复]）, entityId </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">like</span>(<span class="params">element, entityType, entityId</span>) &#123;</span><br><span class="line">  $.<span class="title function_">post</span>(</span><br><span class="line">    <span class="variable constant_">CONTEXT_PATH</span> + <span class="string">&quot;/like&quot;</span>,</span><br><span class="line">    &#123;<span class="string">&quot;entityType&quot;</span>: entityType, <span class="attr">entityId</span>: entityId&#125;,</span><br><span class="line">    <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">      data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(data);</span><br><span class="line">      <span class="comment">//0成功</span></span><br><span class="line">      <span class="keyword">if</span> (data.<span class="property">code</span> === <span class="number">0</span>) &#123;</span><br><span class="line">        $(element).<span class="title function_">children</span>(<span class="string">&quot;i&quot;</span>).<span class="title function_">text</span>(data.<span class="property">likeCount</span>);</span><br><span class="line"></span><br><span class="line">        $(element).<span class="title function_">children</span>(<span class="string">&quot;b&quot;</span>).<span class="title function_">text</span>(data.<span class="property">likeStatus</span> === <span class="number">1</span> ? <span class="string">&quot;已赞&quot;</span> : <span class="string">&quot;赞&quot;</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">alert</span>(data.<span class="property">msg</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--=========详情页点赞操作==========--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--引入Js--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;/js/discuss.js&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 帖子点赞 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:&quot;</span> <span class="attr">th:onclick</span>=<span class="string">&quot;|like(this,1,$&#123;post.id&#125;)|&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">b</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;likeStatus==1?&#x27;已赞&#x27;:&#x27;赞&#x27;&#125;&quot;</span>&gt;</span>赞<span class="tag">&lt;/<span class="name">b</span>&gt;</span> <span class="tag">&lt;<span class="name">i</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;likeCount&#125;&quot;</span>&gt;</span>11<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 评论点赞 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:&quot;</span> <span class="attr">th:onclick</span>=<span class="string">&quot;|like(this,2,$&#123;post.id&#125;)|&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">b</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;cvo.likeStatus==1?&#x27;已赞&#x27;:&#x27;赞&#x27;&#125;&quot;</span>&gt;</span>赞<span class="tag">&lt;/<span class="name">b</span>&gt;</span> <span class="tag">&lt;<span class="name">i</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;cvo.likeCount&#125;&quot;</span>&gt;</span>11<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 回复点赞 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:&quot;</span> <span class="attr">th:onclick</span>=<span class="string">&quot;|like(this,2,$&#123;post.id&#125;)|&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">b</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;rvo.likeStatus==1?&#x27;已赞&#x27;:&#x27;赞&#x27;&#125;&quot;</span>&gt;</span>赞<span class="tag">&lt;/<span class="name">b</span>&gt;</span> <span class="tag">&lt;<span class="name">i</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;rvo.likeCount&#125;&quot;</span>&gt;</span>11<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="7-3-我收到的赞（重构点赞）"><a href="#7-3-我收到的赞（重构点赞）" class="headerlink" title="7.3 我收到的赞（重构点赞）"></a>7.3 我收到的赞（重构点赞）</h2><ul>
<li>重构点赞功能<ul>
<li>以用户id为key，记录点赞功能</li>
<li>increment(key), decrement(key)</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//======================RedisKeyUtil=====================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**某个用户收到的赞【key】====&gt;【 like:user:userId 】==key所对应的值==&gt;【int】*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getUserLikeKey</span><span class="params">(<span class="type">int</span> userId)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> PREFIX_USER_LIKE + SPLIT + userId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//======================LikeService=====================</span></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 点赞 set集合存储谁给某个实体点的赞</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> userId       点赞者</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> entityType   被点赞的实体类型【帖子、评论】</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> entityId     实体id</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> entityUserId 被点赞者</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">like</span><span class="params">(<span class="type">int</span> userId, <span class="type">int</span> entityType, <span class="type">int</span> entityId, <span class="type">int</span> entityUserId)</span> &#123;</span><br><span class="line">    <span class="comment">// 连续两次执行更新操作，因此加上redis事务</span></span><br><span class="line">    redisTemplate.execute(<span class="keyword">new</span> <span class="title class_">SessionCallback</span>() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> Object <span class="title function_">execute</span><span class="params">(RedisOperations operations)</span> <span class="keyword">throws</span> DataAccessException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">entityLikeKey</span> <span class="operator">=</span> RedisKeyUtil.getEntityLikeKey(entityType, entityId);</span><br><span class="line">        <span class="type">String</span> <span class="variable">userLikeKey</span> <span class="operator">=</span> getUserLikeKey(entityUserId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断用户是否点赞 【查询放事务之外】</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">isMember</span> <span class="operator">=</span> operations.opsForSet().isMember(entityLikeKey, userId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 开启事务</span></span><br><span class="line">        operations.multi();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 已赞【取消】</span></span><br><span class="line">        <span class="keyword">if</span> (isMember) &#123;</span><br><span class="line">          operations.opsForSet().remove(entityLikeKey, userId);</span><br><span class="line">          operations.opsForValue().decrement(userLikeKey);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">//点赞</span></span><br><span class="line">          operations.opsForSet().add(entityLikeKey, userId);</span><br><span class="line">          operations.opsForValue().increment(userLikeKey);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//执行事务</span></span><br><span class="line">        <span class="keyword">return</span> operations.exec();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="comment">//点赞</span></span><br><span class="line">    likeService.like(user.getId(), entityType, entityId,entityUserId);</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--=========追加参数==========--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--引入Js--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;/js/discuss.js&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 帖子点赞 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:&quot;</span> <span class="attr">th:onclick</span>=<span class="string">&quot;|like(this,1,$&#123;post.id&#125;,$&#123;post.userId&#125;)|&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">b</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;likeStatus==1?&#x27;已赞&#x27;:&#x27;赞&#x27;&#125;&quot;</span>&gt;</span>赞<span class="tag">&lt;/<span class="name">b</span>&gt;</span> <span class="tag">&lt;<span class="name">i</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;likeCount&#125;&quot;</span>&gt;</span>11<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 评论点赞 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:&quot;</span> <span class="attr">th:onclick</span>=<span class="string">&quot;|like(this,2,$&#123;cvo.comment.id&#125;,$&#123;cvo.comment.userId&#125;)|&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">b</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;cvo.likeStatus==1?&#x27;已赞&#x27;:&#x27;赞&#x27;&#125;&quot;</span>&gt;</span>赞<span class="tag">&lt;/<span class="name">b</span>&gt;</span> <span class="tag">&lt;<span class="name">i</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;cvo.likeCount&#125;&quot;</span>&gt;</span>11<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 回复点赞 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:&quot;</span> <span class="attr">th:onclick</span>=<span class="string">&quot;|like(this,2,$&#123;rvo.reply.id&#125;,$&#123;rvo.reply.userId&#125;&#125;)|&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">b</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;rvo.likeStatus==1?&#x27;已赞&#x27;:&#x27;赞&#x27;&#125;&quot;</span>&gt;</span>赞<span class="tag">&lt;/<span class="name">b</span>&gt;</span> <span class="tag">&lt;<span class="name">i</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;rvo.likeCount&#125;&quot;</span>&gt;</span>11<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">like</span>(<span class="params">element, entityType, entityId, entityUserId</span>) &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="string">&quot;entityType&quot;</span>: entityType,</span><br><span class="line">    <span class="string">&quot;entityId&quot;</span>: entityId,</span><br><span class="line">      <span class="string">&quot;entityUserId&quot;</span>: entityUserId</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-4-用户主页"><a href="#7-4-用户主页" class="headerlink" title="7.4 用户主页"></a>7.4 用户主页</h2><p>包括 查看个人主页和他人主页</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户主页</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;/profile/&#123;userId&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getProfilePage</span><span class="params">(<span class="meta">@PathVariable(&quot;userId&quot;)</span> <span class="type">int</span> userId, Model model)</span> &#123;</span><br><span class="line">  <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserById(userId);</span><br><span class="line">  <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;该用户不存在!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 用户</span></span><br><span class="line">  model.addAttribute(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">  <span class="comment">// 点赞数量</span></span><br><span class="line">  <span class="type">int</span> <span class="variable">likeCount</span> <span class="operator">=</span> likeService.findUserLikeCount(userId);</span><br><span class="line">  model.addAttribute(<span class="string">&quot;likeCount&quot;</span>, likeCount);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;/site/profile&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 进入个人主页 --&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;|/user/profile/$&#123;loginUser.id&#125;|&#125;&quot;</span>&gt;</span>个人主页<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--帖子发布人--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;|/user/profile/$&#123;map.user.id&#125;|&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--查看获赞情况--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span>&gt;</span>获得了 <span class="tag">&lt;<span class="name">i</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;likeCount&#125;&quot;</span>&gt;</span>87<span class="tag">&lt;/<span class="name">i</span>&gt;</span> 个赞<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="8-关注、取关功能"><a href="#8-关注、取关功能" class="headerlink" title="8. 关注、取关功能"></a>8. 关注、取关功能</h1><h2 id="8-1-RedisKey"><a href="#8-1-RedisKey" class="headerlink" title="8.1 RedisKey"></a>8.1 RedisKey</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**关注前缀*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PREFIX_FOLLOWEE</span> <span class="operator">=</span> <span class="string">&quot;followee&quot;</span>;</span><br><span class="line"><span class="comment">/**粉丝前缀*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PREFIX_FOLLOWER</span> <span class="operator">=</span> <span class="string">&quot;follower&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**某个用户关注的实体(用户，帖子) followee:userId:entityType --&gt; zset(entityId, date) */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getFolloweeKey</span><span class="params">(<span class="type">int</span> userId, <span class="type">int</span> entityType)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> PREFIX_FOLLOWEE + SPLIT + userId + SPLIT + entityType;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**某个实体拥有的粉丝 follower:entityType:entityId --&gt;zset(userId, date)*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getFollowerKey</span><span class="params">(<span class="type">int</span> entityType, <span class="type">int</span> entityId)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> PREFIX_FOLLOWER + SPLIT + entityType + SPLIT + entityId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-2-Service"><a href="#8-2-Service" class="headerlink" title="8.2 Service"></a>8.2 Service</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FollowService</span> <span class="keyword">implements</span> <span class="title class_">CommunityConst</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 关注 一项业务两次存储，事务</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">follow</span><span class="params">(<span class="type">int</span> userId, <span class="type">int</span> entityType, <span class="type">int</span> entityId)</span> &#123;</span><br><span class="line">    redisTemplate.execute(<span class="keyword">new</span> <span class="title class_">SessionCallback</span>() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> Object <span class="title function_">execute</span><span class="params">(RedisOperations operations)</span> <span class="keyword">throws</span> DataAccessException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">followeeKey</span> <span class="operator">=</span> RedisKeyUtil.getFolloweeKey(userId, entityType);</span><br><span class="line">        <span class="type">String</span> <span class="variable">followerKey</span> <span class="operator">=</span> RedisKeyUtil.getFollowerKey(entityType, entityId);</span><br><span class="line"></span><br><span class="line">        operations.multi();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// System.currentTimeMillis():用于统计排序列表页</span></span><br><span class="line">        operations.opsForZSet().add(followeeKey, entityId, System.currentTimeMillis());</span><br><span class="line">        operations.opsForZSet().add(followerKey, userId, System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> operations.exec();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 取关 一项业务两次存储，事务</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unfollow</span><span class="params">(<span class="type">int</span> userId, <span class="type">int</span> entityType, <span class="type">int</span> entityId)</span> &#123;</span><br><span class="line">    redisTemplate.execute(<span class="keyword">new</span> <span class="title class_">SessionCallback</span>() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> Object <span class="title function_">execute</span><span class="params">(RedisOperations operations)</span> <span class="keyword">throws</span> DataAccessException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">followeeKey</span> <span class="operator">=</span> RedisKeyUtil.getFolloweeKey(userId, entityType);</span><br><span class="line">        <span class="type">String</span> <span class="variable">followerKey</span> <span class="operator">=</span> RedisKeyUtil.getFollowerKey(entityType, entityId);</span><br><span class="line"></span><br><span class="line">        operations.multi();</span><br><span class="line"></span><br><span class="line">        operations.opsForZSet().remove(followeeKey, entityId);</span><br><span class="line">        operations.opsForZSet().remove(followerKey, userId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> operations.exec();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 查询关注数</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">findFolloweeCount</span><span class="params">(<span class="type">int</span> userId, <span class="type">int</span> entityType)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">followeeKey</span> <span class="operator">=</span> RedisKeyUtil.getFolloweeKey(userId, entityType);</span><br><span class="line">    <span class="comment">//zCard 统计数量</span></span><br><span class="line">    <span class="keyword">return</span> redisTemplate.opsForZSet().zCard(followeeKey);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 查询粉丝数</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">findFollowerCount</span><span class="params">(<span class="type">int</span> entityType, <span class="type">int</span> entityId)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">followerKey</span> <span class="operator">=</span> RedisKeyUtil.getFollowerKey(entityType, entityId);</span><br><span class="line">    <span class="keyword">return</span> redisTemplate.opsForZSet().zCard(followerKey);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 查询当前用户是否已关注该实体</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasFollowed</span><span class="params">(<span class="type">int</span> userId, <span class="type">int</span> entityType, <span class="type">int</span> entityId)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">followeeKey</span> <span class="operator">=</span> RedisKeyUtil.getFolloweeKey(userId, entityType);</span><br><span class="line">    <span class="keyword">return</span> redisTemplate.opsForZSet().score(followeeKey, entityId) != <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 查询某用户关注的人</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">findFollowees</span><span class="params">(<span class="type">int</span> userId, <span class="type">int</span> offset, <span class="type">int</span> limit)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">followeeKey</span> <span class="operator">=</span> RedisKeyUtil.getFolloweeKey(userId, ENTITY_TYPE_USER);</span><br><span class="line">    Set&lt;Integer&gt; targetIds = redisTemplate.opsForZSet()</span><br><span class="line">        .reverseRange(followeeKey, offset, offset + limit - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (targetIds == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;Map&lt;String, Object&gt;&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Integer targetId : targetIds) &#123;</span><br><span class="line">      Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">      <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserById(targetId);</span><br><span class="line">      map.put(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">      <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> redisTemplate.opsForZSet().score(followeeKey, targetId);</span><br><span class="line">      map.put(<span class="string">&quot;followTime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(score.longValue()));</span><br><span class="line">      list.add(map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 查询某用户的粉丝</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">findFollowers</span><span class="params">(<span class="type">int</span> userId, <span class="type">int</span> offset, <span class="type">int</span> limit)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">followerKey</span> <span class="operator">=</span> RedisKeyUtil.getFollowerKey(ENTITY_TYPE_USER, userId);</span><br><span class="line">    Set&lt;Integer&gt; targetIds = redisTemplate.opsForZSet()</span><br><span class="line">        .reverseRange(followerKey, offset, offset + limit - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (targetIds == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;Map&lt;String, Object&gt;&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Integer targetId : targetIds) &#123;</span><br><span class="line">      Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">      <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserById(targetId);</span><br><span class="line">      map.put(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">      <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> redisTemplate.opsForZSet().score(followerKey, targetId);</span><br><span class="line">      map.put(<span class="string">&quot;followTime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(score.longValue()));</span><br><span class="line">      list.add(map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-3-Controller"><a href="#8-3-Controller" class="headerlink" title="8.3 Controller"></a>8.3 Controller</h2><h3 id="8-3-1-功能实现"><a href="#8-3-1-功能实现" class="headerlink" title="8.3.1 功能实现"></a>8.3.1 功能实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FollowController</span> <span class="keyword">implements</span> <span class="title class_">CommunityConst</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> HostHolder hostHolder;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> FollowService followService;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 关注</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@RequestMapping(path = &quot;/follow&quot;, method = RequestMethod.POST)</span></span><br><span class="line">  <span class="meta">@ResponseBody</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">follow</span><span class="params">(<span class="type">int</span> entityType, <span class="type">int</span> entityId)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> hostHolder.getUser();</span><br><span class="line"></span><br><span class="line">    followService.follow(user.getId(), entityType, entityId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> CommunityUtil.getJSONString(<span class="number">0</span>, <span class="string">&quot;关注成功!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 取关</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@RequestMapping(path = &quot;/unfollow&quot;, method = RequestMethod.POST)</span></span><br><span class="line">  <span class="meta">@ResponseBody</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">unfollow</span><span class="params">(<span class="type">int</span> entityType, <span class="type">int</span> entityId)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> hostHolder.getUser();</span><br><span class="line"></span><br><span class="line">    followService.unfollow(user.getId(), entityType, entityId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> CommunityUtil.getJSONString(<span class="number">0</span>, <span class="string">&quot;取关成功!&quot;</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-3-2-显示主页数据"><a href="#8-3-2-显示主页数据" class="headerlink" title="8.3.2 显示主页数据"></a>8.3.2 显示主页数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户主页</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getProfilePage</span><span class="params">(<span class="meta">@PathVariable(&quot;userId&quot;)</span> <span class="type">int</span> userId, Model model)</span> &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 关注数量</span></span><br><span class="line">  <span class="type">long</span> <span class="variable">followeeCount</span> <span class="operator">=</span> followService.findFolloweeCount(userId, ENTITY_TYPE_USER);</span><br><span class="line">  model.addAttribute(<span class="string">&quot;followeeCount&quot;</span>, followeeCount);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 粉丝数量</span></span><br><span class="line">  <span class="type">long</span> <span class="variable">followerCount</span> <span class="operator">=</span> followService.findFollowerCount(ENTITY_TYPE_USER, userId);</span><br><span class="line">  model.addAttribute(<span class="string">&quot;followerCount&quot;</span>, followerCount);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 是否已关注</span></span><br><span class="line">  <span class="type">boolean</span> <span class="variable">hasFollowed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (hostHolder.getUser() != <span class="literal">null</span>) &#123;</span><br><span class="line">    hasFollowed = followService.hasFollowed(hostHolder.getUser().getId(), ENTITY_TYPE_USER,</span><br><span class="line">        userId);</span><br><span class="line">  &#125;</span><br><span class="line">  model.addAttribute(<span class="string">&quot;hasFollowed&quot;</span>, hasFollowed);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;/site/profile&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-4-前端核心"><a href="#8-4-前端核心" class="headerlink" title="8.4 前端核心"></a>8.4 前端核心</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  $(<span class="string">&quot;.follow-btn&quot;</span>).<span class="title function_">click</span>(follow);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">follow</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> btn = <span class="variable language_">this</span>;</span><br><span class="line">  <span class="keyword">if</span> ($(btn).<span class="title function_">hasClass</span>(<span class="string">&quot;btn-info&quot;</span>)) &#123;</span><br><span class="line">    <span class="comment">// 关注</span></span><br><span class="line">    $.<span class="title function_">post</span>(</span><br><span class="line">        <span class="variable constant_">CONTEXT_PATH</span> + <span class="string">&quot;/follow&quot;</span>,</span><br><span class="line">        <span class="comment">//entityId&quot;: $(btn).prev().val():获取前一个节点【隐藏域】中id</span></span><br><span class="line">        &#123;<span class="string">&quot;entityType&quot;</span>: <span class="number">3</span>, <span class="string">&quot;entityId&quot;</span>: $(btn).<span class="title function_">prev</span>().<span class="title function_">val</span>()&#125;,</span><br><span class="line">        <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">          data = $.<span class="title function_">parseJSON</span>(data);</span><br><span class="line">          <span class="keyword">if</span> (data.<span class="property">code</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">reload</span>();</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">alert</span>(data.<span class="property">msg</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 取消关注</span></span><br><span class="line">    $.<span class="title function_">post</span>(</span><br><span class="line">        <span class="variable constant_">CONTEXT_PATH</span> + <span class="string">&quot;/unfollow&quot;</span>,</span><br><span class="line">        &#123;<span class="string">&quot;entityType&quot;</span>: <span class="number">3</span>, <span class="string">&quot;entityId&quot;</span>: $(btn).<span class="title function_">prev</span>().<span class="title function_">val</span>()&#125;,</span><br><span class="line">        <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">          data = $.<span class="title function_">parseJSON</span>(data);</span><br><span class="line">          <span class="keyword">if</span> (data.<span class="property">code</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">reload</span>();</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">alert</span>(data.<span class="property">msg</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    ;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">id</span>=<span class="string">&quot;entityId&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;user.id&#125;&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 只有登录过且当前登录用户不是看的自己的主页就显示已关注/关注TA --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">th:class</span>=<span class="string">&quot;|btn $&#123;hasFollowed?&#x27;btn-secondary&#x27;:&#x27;btn-info&#x27;&#125; btn-sm float-right mr-5 follow-btn|&quot;</span>     					<span class="attr">th:text</span>=<span class="string">&quot;$&#123;hasFollowed?&#x27;已关注&#x27;:&#x27;关注TA&#x27;&#125;&quot;</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;loginUser!=null&amp;&amp;loginUser.id!=user.id&#125;&quot;</span>&gt;</span>关注</span><br><span class="line"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;<span class="name">span</span>&gt;</span>关注 <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;followeeCount&#125;&quot;</span>&gt;</span>5<span class="tag">&lt;/<span class="name">a</span>&gt;</span> 人<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span>&gt;</span>粉丝 <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;followerCount&#125;&quot;</span>&gt;</span>123<span class="tag">&lt;/<span class="name">a</span>&gt;</span> 人<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="9-关注列表（同粉丝列表）"><a href="#9-关注列表（同粉丝列表）" class="headerlink" title="9. 关注列表（同粉丝列表）"></a>9. 关注列表（同粉丝列表）</h1><h2 id="9-1-Servie"><a href="#9-1-Servie" class="headerlink" title="9.1 Servie"></a>9.1 Servie</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询某用户的关注</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">findFollowees</span><span class="params">(<span class="type">int</span> userId, <span class="type">int</span> offset, <span class="type">int</span> limit)</span> &#123;</span><br><span class="line">  <span class="type">String</span> <span class="variable">followeeKey</span> <span class="operator">=</span> RedisKeyUtil.getFolloweeKey(userId, ENTITY_TYPE_USER);</span><br><span class="line">  <span class="comment">// reverseRange：倒序</span></span><br><span class="line">  Set&lt;Integer&gt; targetIds = redisTemplate.opsForZSet().reverseRange(followeeKey, offset, offset + limit - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (targetIds == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  List&lt;Map&lt;String, Object&gt;&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">  <span class="keyword">for</span> (Integer targetId : targetIds) &#123;</span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserById(targetId);</span><br><span class="line">    map.put(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">    <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> redisTemplate.opsForZSet().score(followeeKey, targetId);</span><br><span class="line">    map.put(<span class="string">&quot;followTime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(score.longValue()));</span><br><span class="line">    list.add(map);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="9-2-Controller"><a href="#9-2-Controller" class="headerlink" title="9.2 Controller"></a>9.2 Controller</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询某用户关注的人</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;/followees/&#123;userId&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getFollowees</span><span class="params">(<span class="meta">@PathVariable(&quot;userId&quot;)</span> <span class="type">int</span> userId, Page page, Model model)</span> &#123;</span><br><span class="line">  <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserById(userId);</span><br><span class="line">  <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;该用户不存在!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  model.addAttribute(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line"></span><br><span class="line">  page.setLimit(<span class="number">5</span>);</span><br><span class="line">  page.setPath(<span class="string">&quot;/followees/&quot;</span> + userId);</span><br><span class="line">  page.setRows((<span class="type">int</span>) followService.findFolloweeCount(userId, ENTITY_TYPE_USER));</span><br><span class="line"></span><br><span class="line">  List&lt;Map&lt;String, Object&gt;&gt; userList = followService.findFollowees(userId, page.getOffset(),</span><br><span class="line">      page.getLimit());</span><br><span class="line">  <span class="keyword">if</span> (userList != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (Map&lt;String, Object&gt; map : userList) &#123;</span><br><span class="line">      <span class="type">User</span> <span class="variable">u</span> <span class="operator">=</span> (User) map.get(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">      map.put(<span class="string">&quot;hasFollowed&quot;</span>, hasFollowed(u.getId()));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  model.addAttribute(<span class="string">&quot;users&quot;</span>, userList);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;/site/followee&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 判断当前登录用户与关注、粉丝列表的关注关系</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">hasFollowed</span><span class="params">(<span class="type">int</span> userId)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (hostHolder.getUser() == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> followService.hasFollowed(hostHolder.getUser().getId(), ENTITY_TYPE_USER, userId);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="9-3前端核心"><a href="#9-3前端核心" class="headerlink" title="9.3前端核心"></a>9.3前端核心</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span>&gt;</span>关注 <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;|/followees/$&#123;user.id&#125;|&#125;&quot;</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;followeeCount&#125;&quot;</span>&gt;</span>5<span class="tag">&lt;/<span class="name">a</span>&gt;</span> 人<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span>&gt;</span>粉丝 <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;|/followers/$&#123;user.id&#125;|&#125;&quot;</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;followerCount&#125;&quot;</span>&gt;</span>123<span class="tag">&lt;/<span class="name">a</span>&gt;</span> 人<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">th:each</span>=<span class="string">&quot;map:$&#123;users&#125;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;|/user/profile/&#123;map.user.id&#125;|&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">th:src</span>=<span class="string">&quot;$&#123;map.user.headerUrl&#125;&quot;</span><span class="attr">alt</span>=<span class="string">&quot;用户头像&quot;</span> &gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h6</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:utext</span>=<span class="string">&quot;$&#123;map.user.username&#125;&quot;</span>&gt;</span>落基山脉下的闲人<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>关注于 <span class="tag">&lt;<span class="name">i</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;#dates.format(map.followerTime,&#x27;yyyy-MM-dd HH:mm:ss&#x27;)&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">h6</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">id</span>=<span class="string">&quot;entityId&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;map.user.id&#125;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">th:class</span>=<span class="string">&quot;|$&#123;map.hasFollowed?&#x27;btn-secondary&#x27;:&#x27;btn-info&#x27;&#125;|&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">th:text</span>=<span class="string">&quot;$&#123;map.hasFollowed?&#x27;已关注&#x27;:&#x27;关注TA&#x27;&#125;&quot;</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">th:if</span>=<span class="string">&quot;$&#123;loginUser!=null &amp;&amp; loginUser.id!=map.user.id&#125;&quot;</span>&gt;</span>关注TA</span><br><span class="line">  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id=""><a href="#" class="headerlink" title=""></a></h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/10/%E7%A7%81%E4%BF%A1%E5%8F%8A%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%A8%A1%E5%9D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Daiiiiiiiiiii">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小戴的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/10/%E7%A7%81%E4%BF%A1%E5%8F%8A%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%A8%A1%E5%9D%97/" class="post-title-link" itemprop="url">私信及统一异常处理模块</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-09-10 13:00:21 / 修改时间：13:01:24" itemprop="dateCreated datePublished" datetime="2022-09-10T13:00:21+08:00">2022-09-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">项目笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="5-私信功能"><a href="#5-私信功能" class="headerlink" title="5. 私信功能"></a>5. 私信功能</h1><h2 id="5-1-显示私信"><a href="#5-1-显示私信" class="headerlink" title="5.1 显示私信"></a>5.1 显示私信</h2><h3 id="5-1-1-Dao"><a href="#5-1-1-Dao" class="headerlink" title="5.1.1 Dao"></a>5.1.1 Dao</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">&lt;sql id=<span class="string">&quot;selectFields&quot;</span>&gt;</span><br><span class="line">    id, from_id, to_id, conversation_id, content, status, create_time</span><br><span class="line">&lt;/sql&gt;</span><br><span class="line">  </span><br><span class="line"><span class="comment">//========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**查询当前用户的会话列表,针对每个会话只返回一条最新的私信*/</span></span><br><span class="line">List&lt;Message&gt; <span class="title function_">selectConversations</span><span class="params">(<span class="type">int</span> userId, <span class="type">int</span> offset, <span class="type">int</span> limit)</span>;</span><br><span class="line"></span><br><span class="line">&lt;select id=<span class="string">&quot;selectConversations&quot;</span> resultType=<span class="string">&quot;Message&quot;</span>&gt;</span><br><span class="line">    select &lt;include refid=<span class="string">&quot;selectFields&quot;</span>&gt;&lt;/include&gt;</span><br><span class="line">    from message</span><br><span class="line">    where id <span class="title function_">in</span> <span class="params">(</span></span><br><span class="line"><span class="params">        //子句根据id大小查与每个用户最新的私信（同一会话id越大，私信越新）</span></span><br><span class="line"><span class="params">        select max(id)</span> from message</span><br><span class="line">        where status != <span class="number">2</span> and from_id != <span class="number">1</span> and (from_id = #&#123;userId&#125; <span class="type">or</span> <span class="variable">to_id</span> <span class="operator">=</span> #&#123;userId&#125;)</span><br><span class="line">        group by conversation_id   <span class="comment">//同一会话只显示一条</span></span><br><span class="line">    )</span><br><span class="line">    order by id desc</span><br><span class="line">    limit #&#123;offset&#125;, #&#123;limit&#125;</span><br><span class="line">&lt;/select&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">//========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**查询当前用户的会话数量*/</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">selectConversationCount</span><span class="params">(<span class="type">int</span> userId)</span>;</span><br><span class="line"></span><br><span class="line">&lt;select id=<span class="string">&quot;selectConversationCount&quot;</span> resultType=<span class="string">&quot;int&quot;</span>&gt;</span><br><span class="line">    select <span class="title function_">count</span><span class="params">(m.maxid)</span> from (</span><br><span class="line">       select <span class="title function_">max</span><span class="params">(id)</span> as maxid from message</span><br><span class="line">       where status != <span class="number">2</span> and from_id != <span class="number">1</span> and (from_id = #&#123;userId&#125; <span class="type">or</span> <span class="variable">to_id</span> <span class="operator">=</span> #&#123;userId&#125;)</span><br><span class="line">       group by conversation_id</span><br><span class="line">   ) as m</span><br><span class="line">&lt;/select&gt;</span><br><span class="line">  </span><br><span class="line"><span class="comment">//========================================================</span></span><br><span class="line"><span class="comment">/**查询某个会话所包含的私信列表*/</span></span><br><span class="line">List&lt;Message&gt; <span class="title function_">selectLetters</span><span class="params">(String conversationId, <span class="type">int</span> offset, <span class="type">int</span> limit)</span>;</span><br><span class="line"></span><br><span class="line">&lt;select id=<span class="string">&quot;selectLetters&quot;</span> resultType=<span class="string">&quot;Message&quot;</span>&gt;</span><br><span class="line">    select &lt;include refid=<span class="string">&quot;selectFields&quot;</span>&gt;&lt;/include&gt;</span><br><span class="line">    from message</span><br><span class="line">    where status != <span class="number">2</span></span><br><span class="line">    and from_id != <span class="number">1</span></span><br><span class="line">    <span class="type">and</span> <span class="variable">conversation_id</span> <span class="operator">=</span> #&#123;conversationId&#125;</span><br><span class="line">    order by id asc</span><br><span class="line">    limit #&#123;offset&#125;, #&#123;limit&#125;</span><br><span class="line">&lt;/select&gt;</span><br><span class="line"><span class="comment">//========================================================</span></span><br><span class="line"><span class="comment">/**查询某个会话所包含的私信数量*/</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">selectLetterCount</span><span class="params">(String conversationId)</span>;</span><br><span class="line"></span><br><span class="line">&lt;select id=<span class="string">&quot;selectLetterCount&quot;</span> resultType=<span class="string">&quot;int&quot;</span>&gt;</span><br><span class="line">    select <span class="title function_">count</span><span class="params">(id)</span></span><br><span class="line">    from message</span><br><span class="line">    where status != <span class="number">2</span></span><br><span class="line">    and from_id != <span class="number">1</span></span><br><span class="line">    <span class="type">and</span> <span class="variable">conversation_id</span> <span class="operator">=</span> #&#123;conversationId&#125;</span><br><span class="line">&lt;/select&gt;</span><br><span class="line"><span class="comment">//========================================================</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询未读私信的数量</span></span><br><span class="line"><span class="comment">     * 1.带参数conversationId ：私信未读数量</span></span><br><span class="line"><span class="comment">     * 2.不带参数conversationId ：当前登录用户 所有会话未读数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">selectLetterUnreadCount</span><span class="params">(<span class="type">int</span> userId, String conversationId)</span>;</span><br><span class="line"></span><br><span class="line">&lt;select id=<span class="string">&quot;selectLetterUnreadCount&quot;</span> resultType=<span class="string">&quot;int&quot;</span>&gt;</span><br><span class="line">    select <span class="title function_">count</span><span class="params">(id)</span></span><br><span class="line">    from message</span><br><span class="line">    <span class="type">where</span> <span class="variable">status</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    and from_id != <span class="number">1</span></span><br><span class="line">    <span class="type">and</span> <span class="variable">to_id</span> <span class="operator">=</span> #&#123;userId&#125;</span><br><span class="line">    &lt;<span class="keyword">if</span> test=<span class="string">&quot;conversationId!=null&quot;</span>&gt; <span class="comment">//=null:所有会话未读数 !=null:每条会话未读数</span></span><br><span class="line">        <span class="type">and</span> <span class="variable">conversation_id</span> <span class="operator">=</span> #&#123;conversationId&#125;</span><br><span class="line">    &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>

<h3 id="5-1-2-Service"><a href="#5-1-2-Service" class="headerlink" title="5.1.2 Service"></a>5.1.2 Service</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> MessageMapper messageMapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> List&lt;Message&gt; <span class="title function_">findConversations</span><span class="params">(<span class="type">int</span> userId, <span class="type">int</span> offset, <span class="type">int</span> limit)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> messageMapper.selectConversations(userId, offset, limit);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">findConversationCount</span><span class="params">(<span class="type">int</span> userId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> messageMapper.selectConversationCount(userId);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> List&lt;Message&gt; <span class="title function_">findLetters</span><span class="params">(String conversationId, <span class="type">int</span> offset, <span class="type">int</span> limit)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> messageMapper.selectLetters(conversationId, offset, limit);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">findLetterCount</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> messageMapper.selectLetterCount(conversationId);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">findLetterUnreadCount</span><span class="params">(<span class="type">int</span> userId, String conversationId)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> messageMapper.selectLetterUnreadCount(userId, conversationId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-1-3-Controller"><a href="#5-1-3-Controller" class="headerlink" title="5.1.3 Controller"></a>5.1.3 Controller</h3><p><strong>私信列表</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**私信列表**/</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/letter/list&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getLetterList</span><span class="params">(Model model, Page page)</span>&#123;</span><br><span class="line">    <span class="comment">// 获取当前登录用户</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> hostHolder.getUser();</span><br><span class="line">    <span class="comment">// 分页信息</span></span><br><span class="line">    page.setLimit(<span class="number">5</span>);</span><br><span class="line">    page.setPath(<span class="string">&quot;/letter/list&quot;</span>);</span><br><span class="line">    page.setRows(messageService.findConversationCount(user.getId()));</span><br><span class="line">    <span class="comment">// 会话列表</span></span><br><span class="line">    List&lt;Message&gt; conversationList = messageService.findConversations(user.getId(), page.getOffset(), page.getLimit());</span><br><span class="line">    List&lt;Map&lt;String, Object&gt;&gt; conversations = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (conversationList != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span> (Message message : conversationList)&#123;</span><br><span class="line">            HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            <span class="comment">// 与当前登录用户每一条会话的所有信息</span></span><br><span class="line">            map.put(<span class="string">&quot;conversation&quot;</span>, message);</span><br><span class="line">            <span class="comment">// 当前登录用户与每一个会话人的私信条数</span></span><br><span class="line">            map.put(<span class="string">&quot;letterCount&quot;</span>, messageService.findLetterCount(message.getConversationId()));</span><br><span class="line">            <span class="comment">// 当前登录用户与每一个会话人的未读条数</span></span><br><span class="line">            map.put(<span class="string">&quot;unreadCount&quot;</span>, messageService.findLetterUnreadCount(user.getId(), message.getConversationId()));</span><br><span class="line">            <span class="comment">// 当前登录用户若与当前会话信息中fromId相同，则目标id为ToId;</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">targetId</span> <span class="operator">=</span> user.getId() == message.getFromId() ? message.getToId() : message.getFromId();</span><br><span class="line">            <span class="type">User</span> <span class="variable">target</span> <span class="operator">=</span> userService.findUserById(targetId);</span><br><span class="line">            map.put(<span class="string">&quot;target&quot;</span>, target);</span><br><span class="line">            </span><br><span class="line">            conversations.add(map);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    model.addAttribute(<span class="string">&quot;conversations&quot;</span>, conversations);</span><br><span class="line">    <span class="comment">// 当前登录用户总未读条数</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">letterUnreadCount</span> <span class="operator">=</span> messageService.findLetterUnreadCount(user.getId(), <span class="literal">null</span>);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;letterUnreadCount&quot;</span>, letterUnreadCount);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/site/letter&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>私信详情</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**私信详情**/</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/letter/detail/&#123;conversationId&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getLetterDetail</span><span class="params">(<span class="meta">@PathVariable(&quot;conversationId&quot;)</span>String conversationId, Model model, Page page)</span>&#123;</span><br><span class="line">    <span class="comment">//分页信息</span></span><br><span class="line">    page.setLimit(<span class="number">5</span>);</span><br><span class="line">    page.setPath(<span class="string">&quot;/letter/detail/&quot;</span>+conversationId);</span><br><span class="line">    page.setRows(messageService.findLetterCount(conversationId));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取私信信息</span></span><br><span class="line">    List&lt;Message&gt; letterlist = messageService.findLetters(conversationId, page.getOffset(), page.getLimit());</span><br><span class="line">    List&lt;Map&lt;String, Object&gt;&gt; letters = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (letterlist != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span>(Message message : letterlist)&#123;</span><br><span class="line">            HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            <span class="comment">//map封装每条私信</span></span><br><span class="line">            map.put(<span class="string">&quot;letter&quot;</span>, message);</span><br><span class="line">            map.put(<span class="string">&quot;fromUser&quot;</span>,userService.findUserById(message.getFromId()));</span><br><span class="line"></span><br><span class="line">            letters.add(map);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    model.addAttribute(<span class="string">&quot;letters&quot;</span>,letters);</span><br><span class="line">    <span class="comment">//私信目标</span></span><br><span class="line">    model.addAttribute(<span class="string">&quot;target&quot;</span>,getLetterTarget(conversationId));</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/site/letter-detail&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**封装获取目标会话用户(将如：101_107拆开) **/</span></span><br><span class="line"><span class="keyword">private</span> User <span class="title function_">getLetterTarget</span><span class="params">(String conversationId)</span> &#123;</span><br><span class="line">    String[] ids = conversationId.split(<span class="string">&quot; _&quot;</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">id0</span> <span class="operator">=</span> Integer.parseInt(ids[<span class="number">0</span>]);</span><br><span class="line">    <span class="type">int</span> <span class="variable">id1</span> <span class="operator">=</span> Integer.parseInt(ids[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hostHolder.getUser().getId() == id0) &#123;</span><br><span class="line">        <span class="keyword">return</span> userService.findUserById(id1);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userService.findUserById(id0);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-1-4-页面核心"><a href="#5-1-4-页面核心" class="headerlink" title="5.1.4 页面核心"></a>5.1.4 页面核心</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">letter:</span><br><span class="line">显示未读消息数量</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;nav-link position-relative active&quot;</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;/letter/list&#125;&quot;</span>&gt;</span></span><br><span class="line">  朋友私信<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;badge badge-danger&quot;</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;letterUnreadCount&#125;&quot;</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;letterUnreadCount!=0&#125;&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line">循环处理li</span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;media pb-3 pt-3 mb-3 border-bottom position-relative&quot;</span> <span class="attr">th:each</span>=<span class="string">&quot;map:$&#123;conversations&#125;&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  每个对话的未读数量</span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;badge badge-danger&quot;</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;map.unreadCount&#125;&quot;</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;map.unreadCount!=0&#125;&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">th:src</span>=<span class="string">&quot;$&#123;map.target.headerUrl&#125;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;mr-4 rounded-circle user-header&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;目标用户头像&quot;</span> &gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;text-success&quot;</span> <span class="attr">th:utext</span>=<span class="string">&quot;$&#123;map.target.username&#125;&quot;</span>&gt;</span>目标用户名字<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  消息发布时间</span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;#dates.format(map.conversation.createTime,&#x27;yyyy-MM-dd HH:mm:ss&#x27;)&#125;&quot;</span>&gt;</span>2019-04-28 14:13:25<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  详情页面显示内容为最后一条会话，以及会话包含私信的数量</span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;|/letter/detail/$&#123;map.conversation.conversationId&#125;|&#125;&quot;</span>  <span class="attr">th:utext</span>=<span class="string">&quot;$&#123;map.conversation.content&#125;&quot;</span>&gt;</span>私信正文<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span>共 <span class="tag">&lt;<span class="name">i</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;map.letterCount&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 条会话<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"></span><br><span class="line">detail：</span><br><span class="line">目标人的名字</span><br><span class="line"><span class="tag">&lt;<span class="name">h6</span>&gt;</span>来自 <span class="tag">&lt;<span class="name">i</span> <span class="attr">th:utext</span>=<span class="string">&quot;$&#123;target.username&#125;&quot;</span>&gt;</span>对方<span class="tag">&lt;/<span class="name">i</span>&gt;</span> 的私信<span class="tag">&lt;/<span class="name">h6</span>&gt;</span></span><br><span class="line"></span><br><span class="line">遍历私信内容</span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">th:each</span>=<span class="string">&quot;map:$&#123;letters&#125;&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">th:src</span>=<span class="string">&quot;$&#123;map.fromUser.headerUrl&#125;&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;用户头像&quot;</span> &gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">strong</span>  <span class="attr">th:utext</span>=<span class="string">&quot;$&#123;map.fromUser.username&#125;&quot;</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">small</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;#dates.format(map.letter.createTime,&#x27;yyyy-MM-dd HH:mm:ss&#x27;)&#125;&quot;</span>&gt;</span>时间<span class="tag">&lt;/<span class="name">small</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>  <span class="attr">th:utext</span>=<span class="string">&quot;$&#123;map.letter.content&#125;&quot;</span>&gt;</span>正文<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-2-发送私信"><a href="#5-2-发送私信" class="headerlink" title="5.2 发送私信"></a>5.2 发送私信</h2><h3 id="5-2-1-Dao"><a href="#5-2-1-Dao" class="headerlink" title="5.2.1 Dao"></a>5.2.1 Dao</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/**插入会话**/</span><br><span class="line">int insertMessage(Message message);</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insertMessage&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;Message&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span>&gt;</span></span><br><span class="line">  insert into message(<span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;insertFields&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span>)</span><br><span class="line">  values(#&#123;fromId&#125;,#&#123;toId&#125;,#&#123;conversationId&#125;,#&#123;content&#125;,#&#123;status&#125;,#&#123;createTime&#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**批量更改每个会话的所有未读消息为已读**/</span><br><span class="line">int updateStatus(List<span class="tag">&lt;<span class="name">Integer</span>&gt;</span> ids, int status);</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateStatus&quot;</span>&gt;</span></span><br><span class="line">  update message set status = #&#123;status&#125;</span><br><span class="line">  where id in</span><br><span class="line">   -- 批量传入id</span><br><span class="line">  <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;ids&quot;</span> <span class="attr">item</span>=<span class="string">&quot;id&quot;</span> <span class="attr">open</span>=<span class="string">&quot;(&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span> <span class="attr">close</span>=<span class="string">&quot;)&quot;</span>&gt;</span></span><br><span class="line">    #&#123;id&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="5-2-2-Service"><a href="#5-2-2-Service" class="headerlink" title="5.2.2 Service"></a>5.2.2 Service</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//===========MessageService</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">addMessage</span><span class="params">(Message message)</span>&#123;</span><br><span class="line">  <span class="comment">//转义标签</span></span><br><span class="line">  message.setContent(HtmlUtils.htmlEscape(message.getContent()));</span><br><span class="line">  <span class="comment">//过滤敏感词</span></span><br><span class="line">  message.setContent(sensitiveFilter.filter(message.getContent()));</span><br><span class="line">  <span class="keyword">return</span> messageMapper.insertMessage(message);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">readMessage</span><span class="params">(List&lt;Integer&gt; ids)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> messageMapper.updateStatus(ids, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//========UserService</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">findUserByName</span><span class="params">(String username)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> userMapper.selectByName(username);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-3-Controller"><a href="#5-2-3-Controller" class="headerlink" title="5.2.3 Controller"></a>5.2.3 Controller</h3><p><strong>设置已读</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/letter/detail/&#123;conversationId&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getLetterDetail</span><span class="params">(<span class="meta">@PathVariable(&quot;conversationId&quot;)</span>String conversationId, Model model, Page page)</span>&#123;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * 以上省略。。。。。。</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      <span class="comment">//设置已读(当打开这个页面是就更改status =1)</span></span><br><span class="line">      List&lt;Integer&gt; ids = getLetterIds(letterlist);</span><br><span class="line">      <span class="keyword">if</span> (!ids.isEmpty()) &#123;</span><br><span class="line">          messageService.readMessage(ids);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**获得批量私信的未读数id* */</span></span><br><span class="line"><span class="keyword">private</span> List&lt;Integer&gt; <span class="title function_">getLetterIds</span><span class="params">(List&lt;Message&gt; letterList)</span>&#123;</span><br><span class="line">    List&lt;Integer&gt; ids = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (letterList != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Message message : letterList) &#123;</span><br><span class="line">            <span class="comment">//只有当前登录用户与message列表中目标用户一致并且staus = 0 时才是未读数，加入未读私信集合</span></span><br><span class="line">            <span class="keyword">if</span> (hostHolder.getUser().getId() == message.getToId() &amp;&amp; message.getStatus() == <span class="number">0</span>) &#123;</span><br><span class="line">                ids.add(message.getId());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ids;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>发送私信</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**发送私信* */</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/letter/send&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">sendLetter</span><span class="params">(String toName, String content)</span>&#123;</span><br><span class="line">    <span class="comment">//根据目标发送人姓名获取其id</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">target</span> <span class="operator">=</span> userService.findUserByName(toName);</span><br><span class="line">    <span class="keyword">if</span> (target == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> CommunityUtil.getJSONString(<span class="number">1</span>,<span class="string">&quot;目标用户不存在!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置message属性</span></span><br><span class="line">    <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">    message.setFromId(hostHolder.getUser().getId());</span><br><span class="line">    message.setToId(target.getId());</span><br><span class="line">    message.setContent(content);</span><br><span class="line">    message.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    <span class="comment">// conversationId (如101_102: 小_大)</span></span><br><span class="line">    <span class="keyword">if</span> (message.getFromId() &lt; message.getToId()) &#123;</span><br><span class="line">        message.setConversationId(message.getFromId() + <span class="string">&quot; _&quot;</span> +message.getToId());</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        message.setConversationId(message.getToId() + <span class="string">&quot;_&quot;</span> +message.getFromId());</span><br><span class="line">    &#125;</span><br><span class="line">    messageService.addMessage(message);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> CommunityUtil.getJSONString(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-4-前端核心"><a href="#5-2-4-前端核心" class="headerlink" title="5.2.4 前端核心"></a>5.2.4 前端核心</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//letter页发私信</span></span><br><span class="line">&lt;button type=<span class="string">&quot;button&quot;</span> <span class="keyword">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> id=<span class="string">&quot;sendBtn&quot;</span>&gt;发送&lt;/button&gt;</span><br><span class="line"><span class="comment">//letter-detail页回私信</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;recipient-name&quot;</span> <span class="attr">class</span>=<span class="string">&quot;col-form-label&quot;</span>&gt;</span>发给：<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">id</span>=<span class="string">&quot;recipient-name&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="attr">th:value</span>=<span class="string">&quot;$&#123;target.username&#125;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> <span class="attr">id</span>=<span class="string">&quot;sendBtn&quot;</span>&gt;</span>发送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">//======================js=======================</span></span><br><span class="line"><span class="language-xml">function send_letter() &#123;</span></span><br><span class="line"><span class="language-xml">  $(&quot;#sendModal&quot;).modal(&quot;hide&quot;);</span></span><br><span class="line"><span class="language-xml">  //若用JS异步请求，前端参数不用name= &quot;xxx&quot;,用如下方法</span></span><br><span class="line"><span class="language-xml">  var toName = $(&quot;#recipient-name&quot;).val();</span></span><br><span class="line"><span class="language-xml">  var content = $(&quot;#message-text&quot;).val();</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  $.post(</span></span><br><span class="line"><span class="language-xml">    // 接口路径</span></span><br><span class="line"><span class="language-xml">    CONTEXT_PATH + &quot;/letter/send&quot;,</span></span><br><span class="line"><span class="language-xml">    // 接口参数</span></span><br><span class="line"><span class="language-xml">    &#123;&quot;toName&quot;:toName, &quot;content&quot;:content&#125;,</span></span><br><span class="line"><span class="language-xml">    function (data) &#123;</span></span><br><span class="line"><span class="language-xml">      // 把&#123;&quot;toName&quot;:toName, &quot;content&quot;:content&#125;转换成JS对象</span></span><br><span class="line"><span class="language-xml">      data = $.parseJSON(data);</span></span><br><span class="line"><span class="language-xml">      // 与CommunityUtil.getJSONString(0,&quot;msg&quot;)匹配--0：成功</span></span><br><span class="line"><span class="language-xml">      if (data.code == 0)&#123;</span></span><br><span class="line"><span class="language-xml">        $(&quot;#hintBody&quot;).text(&quot;发送成功！&quot;);</span></span><br><span class="line"><span class="language-xml">      &#125;else &#123;</span></span><br><span class="line"><span class="language-xml">        $(&quot;#hintBody&quot;).text(data.msg);</span></span><br><span class="line"><span class="language-xml">      &#125;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      $(&quot;#hintModal&quot;).modal(&quot;show&quot;);</span></span><br><span class="line"><span class="language-xml">      setTimeout(function()&#123;</span></span><br><span class="line"><span class="language-xml">        $(&quot;#hintModal&quot;).modal(&quot;hide&quot;);</span></span><br><span class="line"><span class="language-xml">        //刷新页面</span></span><br><span class="line"><span class="language-xml">        location.reload();</span></span><br><span class="line"><span class="language-xml">      &#125;, 2000);</span></span><br><span class="line"><span class="language-xml">    &#125;</span></span><br><span class="line"><span class="language-xml">  );</span></span><br><span class="line"><span class="language-xml">&#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="6-统一异常处理"><a href="#6-统一异常处理" class="headerlink" title="6. 统一异常处理"></a>6. 统一异常处理</h1><ul>
<li>错误页面放在resources.templates.error下，这样出错后自动跳到错误页面</li>
</ul>
<p><img src="/img/image-20220731134215592.png" alt="image-20220731134215592"></p>
<ul>
<li>在HomeController 里声明方法getErrorPage()错误访问页面</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(path = &quot;/error&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getErrorPage</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/error/500&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>统一处理异常</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在HomeController 里声明方法getErrorPage()错误访问页面</span></span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;/error&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getErrorPage</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/error/500&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice(annotations = Controller.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExceptionUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(ExceptionUtil.class);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ExceptionHandler(&#123;Exception.class&#125;)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleException</span><span class="params">(Exception e, HttpServletRequest request, HttpServletResponse response)</span></span><br><span class="line">      <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 错误概括</span></span><br><span class="line">    logger.error(<span class="string">&quot;服务器发生异常: &quot;</span> + e.getMessage());</span><br><span class="line">    <span class="comment">// 错误详情</span></span><br><span class="line">    <span class="keyword">for</span> (StackTraceElement element : e.getStackTrace()) &#123;</span><br><span class="line">      logger.error(element.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获得请求方式</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">xRequestedWith</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;x-requested-with&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;XMLHttpRequest&quot;</span>.equals(xRequestedWith)) &#123;</span><br><span class="line">      response.setContentType(<span class="string">&quot;application/plain;charset=utf-8&quot;</span>);</span><br><span class="line">      <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">      writer.write(CommunityUtil.getJSONString(<span class="number">1</span>, <span class="string">&quot;服务器异常!&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      response.sendRedirect(request.getContextPath() + <span class="string">&quot;/error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id=""><a href="#" class="headerlink" title=""></a></h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/10/%E5%B8%96%E5%AD%90%E5%8F%8A%E8%AF%84%E8%AE%BA%E6%A8%A1%E5%9D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Daiiiiiiiiiii">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小戴的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/10/%E5%B8%96%E5%AD%90%E5%8F%8A%E8%AF%84%E8%AE%BA%E6%A8%A1%E5%9D%97/" class="post-title-link" itemprop="url">帖子及评论模块</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-09-10 12:57:54 / 修改时间：12:58:55" itemprop="dateCreated datePublished" datetime="2022-09-10T12:57:54+08:00">2022-09-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">项目笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="3-发布帖子"><a href="#3-发布帖子" class="headerlink" title="3. 发布帖子"></a>3. 发布帖子</h1><h2 id="3-1-过滤敏感词"><a href="#3-1-过滤敏感词" class="headerlink" title="3.1 过滤敏感词"></a>3.1 过滤敏感词</h2><p>前缀树【tire树】 ：</p>
<ul>
<li>根节点不包含字符，除根节点以外的每个节点，只包含一个字符</li>
<li>从根节点到某一个节点，路径上经过的字符连接起来，为该节点对应字符串</li>
<li>每个节点的所有子节点，包含的字符串不相同</li>
</ul>
<p>核心 ：</p>
<ul>
<li>有一个指针指向前缀树，默认指向根节点，用以遍历敏感词的每一个字符</li>
<li>有一个指针指向被过滤字符串，用以标识敏感词的开头</li>
<li>有一个指针指向被过滤字符串，用以标识敏感词的结尾</li>
<li>2一直往下走，3可能会往回重新标记</li>
</ul>
<p><img src="/img/%E5%89%8D%E7%BC%80%E6%A0%91_nTNaIPnorr.PNG" alt="img"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description: 敏感词过滤器</span></span><br><span class="line"><span class="comment"> * 定义前缀树---根据敏感词---初始化前缀树---编写过滤敏感词的方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SensitiveFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(SensitiveFilter.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 替换符</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REPLACEMENT</span> <span class="operator">=</span> <span class="string">&quot;***&quot;</span>;</span><br><span class="line">    <span class="comment">// 根节点</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">TrieNode</span> <span class="variable">rootNode</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TrieNode</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据敏感词文件构造树形 <span class="doctag">@PostConstruct</span>:标记方法为初始化方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getClassLoader()</span><br><span class="line">                        .getResourceAsStream(<span class="string">&quot;sensitive-words.txt&quot;</span>);</span><br><span class="line">                <span class="comment">//字节流--字符流--缓冲流【效率更高】</span></span><br><span class="line">                <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(inputStream));</span><br><span class="line">        ) &#123;</span><br><span class="line">            String keyword;</span><br><span class="line">            <span class="comment">//读到敏感词</span></span><br><span class="line">            <span class="keyword">while</span> ((keyword = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 添加到前缀树</span></span><br><span class="line">                <span class="built_in">this</span>.addKeyword(keyword);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;加载敏感词文件失败&quot;</span>, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将一个敏感词添加到前缀树中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addKeyword</span><span class="params">(String keyword)</span> &#123;</span><br><span class="line">        <span class="comment">//相当于一个指针[表示当前节点，默认为根节点]</span></span><br><span class="line">        <span class="type">TrieNode</span> <span class="variable">tempNode</span> <span class="operator">=</span> rootNode;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; keyword.length(); i++) &#123;</span><br><span class="line">            <span class="comment">//将汉字转化为Char值</span></span><br><span class="line">            <span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> keyword.charAt(i);</span><br><span class="line">            <span class="comment">//获取字节点</span></span><br><span class="line">            <span class="type">TrieNode</span> <span class="variable">subNode</span> <span class="operator">=</span> tempNode.getSubNode(c);</span><br><span class="line">            <span class="comment">//判空</span></span><br><span class="line">            <span class="keyword">if</span> (subNode == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 初始化子节点并加入到当前节点下</span></span><br><span class="line">                subNode = <span class="keyword">new</span> <span class="title class_">TrieNode</span>();</span><br><span class="line">                tempNode.addSubNode(c, subNode);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 指向子节点,进入下一轮循环</span></span><br><span class="line">            tempNode = subNode;</span><br><span class="line">            <span class="comment">// 设置结束标识</span></span><br><span class="line">            <span class="keyword">if</span> (i == keyword.length() - <span class="number">1</span>) &#123;</span><br><span class="line">                tempNode.setKeywordEnd(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 过滤敏感词</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> text 待过滤的文本</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 过滤后的文本</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">filter</span><span class="params">(String text)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(text)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 指针1</span></span><br><span class="line">        <span class="type">TrieNode</span> <span class="variable">tempNode</span> <span class="operator">=</span> rootNode;</span><br><span class="line">        <span class="comment">// 指针2</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">begin</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 指针3</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">position</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 结果</span></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (position &lt; text.length()) &#123;</span><br><span class="line">            <span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> text.charAt(position);</span><br><span class="line">            <span class="comment">// 跳过符号</span></span><br><span class="line">            <span class="keyword">if</span> (isSymbol(c)) &#123;</span><br><span class="line">                <span class="comment">// 若指针1处于根节点,将此符号计入结果,让指针2向下走一步</span></span><br><span class="line">                <span class="keyword">if</span> (tempNode == rootNode) &#123;</span><br><span class="line">                    sb.append(c);</span><br><span class="line">                    begin++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 无论符号在开头或中间,指针3都向下走一步</span></span><br><span class="line">                position++;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 检查下级节点</span></span><br><span class="line">            tempNode = tempNode.getSubNode(c);</span><br><span class="line">            <span class="keyword">if</span> (tempNode == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 以begin开头的字符串不是敏感词</span></span><br><span class="line">                sb.append(text.charAt(begin));</span><br><span class="line">                <span class="comment">// 进入下一个位置</span></span><br><span class="line">                position = ++begin;</span><br><span class="line">                <span class="comment">// 重新指向根节点</span></span><br><span class="line">                tempNode = rootNode;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tempNode.isKeywordEnd()) &#123;</span><br><span class="line">                <span class="comment">// 发现敏感词,将begin~position字符串替换掉</span></span><br><span class="line">                sb.append(REPLACEMENT);</span><br><span class="line">                <span class="comment">// 进入下一个位置</span></span><br><span class="line">                begin = ++position;</span><br><span class="line">                <span class="comment">// 重新指向根节点</span></span><br><span class="line">                tempNode = rootNode;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 检查下一个字符</span></span><br><span class="line">                position++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将最后一批字符计入结果</span></span><br><span class="line">        sb.append(text.substring(begin));</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断是否为符号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isSymbol</span><span class="params">(Character c)</span> &#123;</span><br><span class="line">        <span class="comment">// 0x2E80~0x9FFF 是东亚文字范围</span></span><br><span class="line">        <span class="keyword">return</span> !CharUtils.isAsciiAlphanumeric(c) &amp;&amp; (c &lt; <span class="number">0x2E80</span> || c &gt; <span class="number">0x9FFF</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前定义的数据结构 其实是描述前缀树的某一结点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">TrieNode</span> &#123;</span><br><span class="line">        <span class="comment">// 关键词结束标识【是不是一个单词的结尾】</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isKeywordEnd</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// // 子节点(key是下级字符,value是下级节点)</span></span><br><span class="line">        <span class="keyword">private</span> Map&lt;Character, TrieNode&gt; subNodes = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加子节点</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSubNode</span><span class="params">(Character c, TrieNode node)</span> &#123;</span><br><span class="line">            subNodes.put(c, node);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取子节点</span></span><br><span class="line">        <span class="keyword">public</span> TrieNode <span class="title function_">getSubNode</span><span class="params">(Character c)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> subNodes.get(c);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isKeywordEnd</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> isKeywordEnd;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setKeywordEnd</span><span class="params">(<span class="type">boolean</span> keywordEnd)</span> &#123;</span><br><span class="line">            isKeywordEnd = keywordEnd;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-2-发布帖子"><a href="#3-2-发布帖子" class="headerlink" title="3.2 发布帖子"></a>3.2 发布帖子</h2><p>异步：</p>
<p>1 理解为你派小弟去干个活，你该干啥还是干啥。如果需要小弟完事后向你汇报，这就是有回调的异步，反之亦然；</p>
<p>2 整个网页不刷新，访问服务器资源返回结果，实现局部的刷新</p>
<h3 id="3-2-1-后端核心"><a href="#3-2-1-后端核心" class="headerlink" title="3.2.1 后端核心"></a>3.2.1 后端核心</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//JSON工具类，将对象转为JSON字符串</span></span><br><span class="line">  public <span class="keyword">static</span> <span class="title class_">String</span> <span class="title function_">getJSONString</span>(<span class="params">int code, <span class="built_in">String</span> msg, <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt; map</span>) &#123;</span><br><span class="line">      <span class="title class_">JSON</span><span class="built_in">Object</span> json = <span class="keyword">new</span> <span class="title class_">JSON</span><span class="built_in">Object</span>();</span><br><span class="line">      json.<span class="title function_">put</span>(<span class="string">&quot;code&quot;</span>,code);</span><br><span class="line">      json.<span class="title function_">put</span>(<span class="string">&quot;msg&quot;</span>,msg);</span><br><span class="line">      <span class="keyword">if</span> (map != <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">//从map里的key集合中取出每一个key</span></span><br><span class="line">          <span class="keyword">for</span> (<span class="title class_">String</span> key : map.<span class="title function_">keySet</span>()) &#123;</span><br><span class="line">              json.<span class="title function_">put</span>(key, map.<span class="title function_">get</span>(key));</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> json.<span class="title function_">toJSONString</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  public <span class="keyword">static</span> <span class="title class_">String</span> <span class="title function_">getJSONString</span>(<span class="params">int code, <span class="built_in">String</span> msg</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getJSONString</span>(code, msg, <span class="literal">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  public <span class="keyword">static</span> <span class="title class_">String</span> <span class="title function_">getJSONString</span>(<span class="params">int code</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getJSONString</span>(code, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">------------mapper---------------</span><br><span class="line">int insertDiscussPost(DiscussPost discussPost);</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;insertFields&quot;</span>&gt;</span></span><br><span class="line">    user_id,title,content,type,status,create_time,comment_count,score</span><br><span class="line"><span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insertDiscussPost&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;DiscussPost&quot;</span>&gt;</span></span><br><span class="line">    insert into discuss_post(<span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;insertFields&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span>)</span><br><span class="line">    values (#&#123;userId&#125;, #&#123;title&#125;, #&#123;content&#125;, #&#123;type&#125;, #&#123;status&#125;, #&#123;createTime&#125;, #&#123;commentCount&#125;, #&#123;score&#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//============service===============</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">addDiscussPost</span><span class="params">(DiscussPost post)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(post == <span class="literal">null</span>)&#123;</span><br><span class="line">          <span class="comment">//不用map直接抛异常</span></span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;参数不能为空！&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//转义HTML标签,Springboot自带转义工具HtmlUtils.htmlEscape()</span></span><br><span class="line">      post.setTitle(HtmlUtils.htmlEscape(post.getTitle()));</span><br><span class="line">      post.setContent(HtmlUtils.htmlEscape(post.getContent()));</span><br><span class="line">      <span class="comment">//过滤敏感词</span></span><br><span class="line">      post.setTitle(sensitiveFilter.filter(post.getTitle()));</span><br><span class="line">      post.setContent(sensitiveFilter.filter(post.getContent()));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> discussPostMapper.insertDiscussPost(post);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//===========controller============</span></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> DiscussPostService discussPostService;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> HostHolder hostHolder;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@RequestMapping(value = &quot;/add&quot;, method = RequestMethod.POST)</span></span><br><span class="line">  <span class="meta">@ResponseBody</span>    <span class="comment">//返回Json格式，一定要加@ResponseBody</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">addDiscussPost</span><span class="params">(String title, String content)</span>&#123;</span><br><span class="line">      <span class="comment">//获取当前登录的用户</span></span><br><span class="line">      <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> hostHolder.getUser();</span><br><span class="line">      <span class="keyword">if</span> (user == <span class="literal">null</span>)&#123;</span><br><span class="line">          <span class="comment">//403权限不够</span></span><br><span class="line">          <span class="keyword">return</span> CommunityUtil.getJSONString(<span class="number">403</span>,<span class="string">&quot;你还没有登录哦！&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="type">DiscussPost</span> <span class="variable">post</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DiscussPost</span>();</span><br><span class="line">      post.setUserId(user.getId());</span><br><span class="line">      post.setTitle(title);</span><br><span class="line">      post.setContent(content);</span><br><span class="line">      post.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">      <span class="comment">//业务处理，将用户给的title，content进行处理并添加进数据库</span></span><br><span class="line">      discussPostService.addDiscussPost(post);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//返回Json格式字符串给前端JS,报错的情况将来统一处理</span></span><br><span class="line">      <span class="keyword">return</span> CommunityUtil.getJSONString(<span class="number">0</span>,<span class="string">&quot;发布成功！&quot;</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-2-前端核心"><a href="#3-2-2-前端核心" class="headerlink" title="3.2.2 前端核心"></a>3.2.2 前端核心</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//js</span></span><br><span class="line">$(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  $(<span class="string">&quot;#publishBtn&quot;</span>).<span class="title function_">click</span>(publish);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">publish</span>(<span class="params"></span>) &#123;</span><br><span class="line">  $(<span class="string">&quot;#publishModal&quot;</span>).<span class="title function_">modal</span>(<span class="string">&quot;hide&quot;</span>);</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 获取标题和内容</span></span><br><span class="line">  <span class="keyword">var</span> title = $(<span class="string">&quot;#recipient-name&quot;</span>).<span class="title function_">val</span>();</span><br><span class="line">  <span class="keyword">var</span> content = $(<span class="string">&quot;#message-text&quot;</span>).<span class="title function_">val</span>();</span><br><span class="line">  <span class="comment">// 发送异步请求(POST)</span></span><br><span class="line">  $.<span class="title function_">post</span>(</span><br><span class="line">    <span class="variable constant_">CONTEXT_PATH</span> + <span class="string">&quot;/discuss/add&quot;</span>,</span><br><span class="line">    <span class="comment">//与Controller层两个属性要一致！！！</span></span><br><span class="line">    &#123;<span class="string">&quot;title&quot;</span>:title,<span class="string">&quot;content&quot;</span>:content&#125;,</span><br><span class="line">    <span class="keyword">function</span>(<span class="params">data</span>) &#123;</span><br><span class="line">      <span class="comment">//把json字符串转化成Js对象,后面才可以调用data.msg</span></span><br><span class="line">      data = $.<span class="title function_">parseJSON</span>(data);</span><br><span class="line">      <span class="comment">// 在提示框中显示返回消息</span></span><br><span class="line">      $(<span class="string">&quot;#hintBody&quot;</span>).<span class="title function_">text</span>(data.<span class="property">msg</span>);</span><br><span class="line">      <span class="comment">// 显示提示框</span></span><br><span class="line">      $(<span class="string">&quot;#hintModal&quot;</span>).<span class="title function_">modal</span>(<span class="string">&quot;show&quot;</span>);</span><br><span class="line">      <span class="comment">// 2秒后,自动隐藏提示框</span></span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        $(<span class="string">&quot;#hintModal&quot;</span>).<span class="title function_">modal</span>(<span class="string">&quot;hide&quot;</span>);</span><br><span class="line">        <span class="comment">// 刷新页面</span></span><br><span class="line">        <span class="keyword">if</span>(data.<span class="property">code</span> == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">reload</span>();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, <span class="number">2000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-3-帖子详情"><a href="#3-3-帖子详情" class="headerlink" title="3.3 帖子详情"></a>3.3 帖子详情</h2><h3 id="3-3-1-后端核心"><a href="#3-3-1-后端核心" class="headerlink" title="3.3.1 后端核心"></a>3.3.1 后端核心</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DiscussPost selectDiscussPostById(int id);</span><br><span class="line">&lt;----------------------&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectDiscussPostById&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;DiscussPost&quot;</span>&gt;</span></span><br><span class="line">    select <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;selectFields&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">    from discuss_post</span><br><span class="line">    where id = #&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> DiscussPost <span class="title function_">findDiscussPostById</span><span class="params">(<span class="type">int</span> id)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> discussPostMapper.selectDiscussPostById(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/detail/&#123;discussPostId&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getDiscusspost</span><span class="params">(<span class="meta">@PathVariable(&quot;discussPostId&quot;)</span> <span class="type">int</span> discussPostId, Model model)</span>&#123;</span><br><span class="line">    <span class="comment">//通过前端传来的Id查询帖子</span></span><br><span class="line">    <span class="type">DiscussPost</span> <span class="variable">post</span> <span class="operator">=</span> discussPostService.findDiscussPostById(discussPostId);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;post&quot;</span>,post);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用以显示发帖人的头像及用户名</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserById(post.getUserId());</span><br><span class="line">    model.addAttribute(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/site/discuss-detail&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-2-前端核心"><a href="#3-3-2-前端核心" class="headerlink" title="3.3.2 前端核心"></a>3.3.2 前端核心</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--前端点击进入详情的链接--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">th:each</span>=<span class="string">&quot;map:$&#123;discussPosts&#125;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;|/discuss/detail/$&#123;map.post.id&#125;|&#125;&quot;</span> <span class="attr">th:utext</span>=<span class="string">&quot;$&#123;map.post.title&#125;&quot;</span>&gt;</span>标题链接<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"></span><br><span class="line">th:utext=&quot;$&#123;post.getTitle()&#125;&quot;     <span class="comment">&lt;!--标题--&gt;</span></span><br><span class="line">th:src=&quot;$&#123;user.getHeaderUrl()&#125;&quot;   <span class="comment">&lt;!--用户头像--&gt;</span></span><br><span class="line">th:utext=&quot;$&#123;user.getUsername()&#125;&quot;  <span class="comment">&lt;!--用户名字--&gt;</span></span><br><span class="line">th:text=&quot;$&#123;#dates.format(post.getCreateTime(),&#x27;yyyy-MM-dd HH:mm:ss&#x27;)&#125;&quot;   <span class="comment">&lt;!--发帖时间--&gt;</span></span><br><span class="line">th:utext=&quot;$&#123;post.getContent()&#125;&quot;   <span class="comment">&lt;!--发帖内容--&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="4-评论功能"><a href="#4-评论功能" class="headerlink" title="4. 评论功能"></a>4. 评论功能</h1><h2 id="4-1-显示评论"><a href="#4-1-显示评论" class="headerlink" title="4.1 显示评论"></a>4.1 显示评论</h2><h3 id="4-1-1-Dao"><a href="#4-1-1-Dao" class="headerlink" title="4.1.1 Dao"></a>4.1.1 Dao</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">List<span class="tag">&lt;<span class="name">Comment</span>&gt;</span> selectCommentByEntity(int entityType, int entityId, int offset, int limit); </span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectCommentByEntity&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.dai.community.entity.Comment&quot;</span>&gt;</span></span><br><span class="line">    select<span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;selectFields&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">    from comment</span><br><span class="line">    where status = 0 and entity_type=#&#123;entityType&#125; and entity_id =#&#123;entityId&#125;</span><br><span class="line">    order by create_time</span><br><span class="line">    limit #&#123;offset&#125;,#&#123;limit&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">**********************************************************************************</span><br><span class="line">  int selectCountByEntity(int entityType, int entityId);    </span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectCountByEntity&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;java.lang.Integer&quot;</span>&gt;</span></span><br><span class="line">    select count(id)</span><br><span class="line">    from comment</span><br><span class="line">    where status = 0 and entity_type = #&#123;entityType&#125; and entity_id = #&#123;entityId&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="4-1-2-Service"><a href="#4-1-2-Service" class="headerlink" title="4.1.2 Service"></a>4.1.2 Service</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Comment&gt; <span class="title function_">findComments</span><span class="params">(<span class="type">int</span> type, <span class="type">int</span> id, <span class="type">int</span> offset, <span class="type">int</span> limit)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> commentMapper.selectCommentByEntity(type, id, offset, limit);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">findCommentCount</span><span class="params">(<span class="type">int</span> type, <span class="type">int</span> id)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> commentMapper.selectCountByEntity(type, id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-1-3-Controller（接查看帖子详情）"><a href="#4-1-3-Controller（接查看帖子详情）" class="headerlink" title="4.1.3 Controller（接查看帖子详情）"></a>4.1.3 Controller（接查看帖子详情）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/detail/&#123;postId&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getDetailPage</span><span class="params">(<span class="meta">@PathVariable(&quot;postId&quot;)</span> <span class="type">int</span> postId, Model model, Page page)</span> &#123;</span><br><span class="line">  <span class="comment">//帖子</span></span><br><span class="line">  <span class="type">DiscussPost</span> <span class="variable">post</span> <span class="operator">=</span> discussPostService.findPost(postId);</span><br><span class="line">  model.addAttribute(<span class="string">&quot;post&quot;</span>, post);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//用以显示发帖人的头像及用户名</span></span><br><span class="line">  <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserById(post.getUserId());</span><br><span class="line">  model.addAttribute(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//评论分页信息</span></span><br><span class="line">  page.setLimit(<span class="number">5</span>);</span><br><span class="line">  page.setPath(<span class="string">&quot;/discuss/detail/&quot;</span> + postId);</span><br><span class="line">  page.setRows(post.getCommentCount());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 评论: 给帖子的评论</span></span><br><span class="line">  <span class="comment">// 回复: 给评论的评论</span></span><br><span class="line">  <span class="comment">// 评论列表集合</span></span><br><span class="line">  List&lt;Comment&gt; commentList = commentService.findComments(ENTITY_TYPE_POST, post.getId(), page.getOffset(), page.getLimit());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 评论VO(viewObject[显示对象]) (将comment,user信息封装到一个Map，Map再封装到List中)</span></span><br><span class="line">  List&lt;Map&lt;String, Object&gt;&gt; commentVoList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (commentList != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 每一条评论及该评论的用户封装进map集合</span></span><br><span class="line">    <span class="keyword">for</span> (Comment comment : commentList) &#123;</span><br><span class="line">      <span class="comment">// 评论Map--&gt;commentVo</span></span><br><span class="line">      HashMap&lt;String, Object&gt; commentVo = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">      <span class="comment">// 评论</span></span><br><span class="line">      commentVo.put(<span class="string">&quot;comment&quot;</span>, comment);</span><br><span class="line">      <span class="comment">// 评论作者</span></span><br><span class="line">      commentVo.put(<span class="string">&quot;user&quot;</span>, userService.findUserById(comment.getUserId()));</span><br><span class="line"></span><br><span class="line">      <span class="comment">//==========================================================</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">//回复列表（每一条评论的所有回复,不分页）</span></span><br><span class="line">      List&lt;Comment&gt; replyList = commentService.findComments(ENTITY_TYPE_COMMENT, comment.getId(), <span class="number">0</span>, Integer.MAX_VALUE);</span><br><span class="line">      <span class="comment">// 回复VO</span></span><br><span class="line">      List&lt;Map&lt;String, Object&gt;&gt; replyVoList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">      <span class="keyword">if</span> (replyList != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Comment reply : replyList) &#123;</span><br><span class="line">          HashMap&lt;String, Object&gt; replyVo = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">          <span class="comment">// 回复</span></span><br><span class="line">          replyVo.put(<span class="string">&quot;reply&quot;</span>, reply);</span><br><span class="line">          <span class="comment">// 作者</span></span><br><span class="line">          replyVo.put(<span class="string">&quot;user&quot;</span>, userService.findUserById(reply.getUserId()));</span><br><span class="line">          <span class="comment">// 回复目标 (有2种：1.直接回复【targetId没值】 2.追加回复【targetId有值】)</span></span><br><span class="line">          <span class="type">User</span> <span class="variable">target</span> <span class="operator">=</span> reply.getTargetId() == <span class="number">0</span> ? <span class="literal">null</span> : userService.findUserById(reply.getTargetId());</span><br><span class="line">          replyVo.put(<span class="string">&quot;target&quot;</span>, target);</span><br><span class="line">          <span class="comment">// 将每一个回复Map放在回复List中</span></span><br><span class="line">          replyVoList.add(replyVo);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 将每一个回复List放在评论Map中</span></span><br><span class="line">      commentVo.put(<span class="string">&quot;replies&quot;</span>, replyVoList);</span><br><span class="line">      <span class="comment">// 回复数量统计</span></span><br><span class="line">      <span class="type">int</span> <span class="variable">replyCount</span> <span class="operator">=</span> commentService.findCommentCount(ENTITY_TYPE_COMMENT, comment.getId());</span><br><span class="line">      commentVo.put(<span class="string">&quot;replyCount&quot;</span>, replyCount);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 再将每一个评论Map放在评论List中</span></span><br><span class="line">      commentVoList.add(commentVo);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  model.addAttribute(<span class="string">&quot;comments&quot;</span>, commentVoList);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;site/discuss-detail&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-1-4-前端核心"><a href="#4-1-4-前端核心" class="headerlink" title="4.1.4 前端核心"></a>4.1.4 前端核心</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 回帖列表 类型为1 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;media pb-3 pt-3 mb-3 border-bottom&quot;</span> <span class="attr">th:each</span>=<span class="string">&quot;cvo:$&#123;comments&#125;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">th:src</span>=<span class="string">&quot;$&#123;cvo.user.getHeaderUrl()&#125;&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;用户头像&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:utext</span>=<span class="string">&quot;$&#123;cvo.user.getUsername()&#125;&quot;</span>&gt;</span>用户姓名<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">i</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;page.offset + cvoStat.count&#125;&quot;</span>&gt;</span>1 评论楼层<span class="tag">&lt;/<span class="name">i</span>&gt;</span>#</span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">th:utext</span>=<span class="string">&quot;$&#123;cvo.comment.content&#125;&quot;</span>&gt;</span></span><br><span class="line">    评论内容</span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>发布于 <span class="tag">&lt;<span class="name">b</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;#dates.format(cvo.comment.createTime,&#x27;yyyy-MM-dd HH:mm:sss&#x27;)&#125;&quot;</span>&gt;</span>时间<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span>回复(<span class="tag">&lt;<span class="name">i</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;cvo.replyCount&#125;&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">i</span>&gt;</span>)<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 回复列表 类型为2 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">th:each</span>=<span class="string">&quot;rvo:$&#123;cvo.replies&#125;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--直接回复 无targetId--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;rvo.target==null&#125;&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">b</span> <span class="attr">th:utext</span>=<span class="string">&quot;$&#123;rvo.user.username&#125;&quot;</span>&gt;</span>回复人姓名<span class="tag">&lt;/<span class="name">b</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--追加回复 有targetId--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;rvo.target!=null&#125;&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">i</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;rvo.user.username&#125;&quot;</span>&gt;</span>回复人姓名<span class="tag">&lt;/<span class="name">i</span>&gt;</span> 回复<span class="tag">&lt;<span class="name">b</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;rvo.target.username&#125;&quot;</span>&gt;</span>被回复人姓名<span class="tag">&lt;/<span class="name">b</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:utext</span>=<span class="string">&quot;$&#123;rvo.reply.content&#125;&quot;</span>&gt;</span>回复内容<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;#dates.format(rvo.reply.createTime,&#x27;yyyy-MM-dd HH:mm:ss&#x27;)&#125;&quot;</span>&gt;</span>回复时间<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--关联id对应回复  动态拼接--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;| #huifu-$&#123;rvoStat.count&#125;|&quot;</span> <span class="attr">data-toggle</span>=<span class="string">&quot;collapse&quot;</span>&gt;</span>回复<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">th:id</span>=<span class="string">&quot;|huifu-$&#123;rvoStat.count&#125;|&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">th:placeholder</span>=<span class="string">&quot;|回复$&#123;rvo.user.username&#125;|&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;#&quot;</span>&gt;</span>回复<span class="tag">&lt;/<span class="name">button</span>&gt;</span>                   </span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span>                </span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">最后复用分页：th:replace=&quot;index::pagination&quot;</span><br></pre></td></tr></table></figure>

<h2 id="4-2-发布评论"><a href="#4-2-发布评论" class="headerlink" title="4.2 发布评论"></a>4.2 发布评论</h2><h3 id="4-2-1-后端核心"><a href="#4-2-1-后端核心" class="headerlink" title="4.2.1 后端核心"></a>4.2.1 后端核心</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//CommentMapper </span></span><br><span class="line"><span class="type">int</span> <span class="title function_">insertComment</span><span class="params">(Comment comment)</span>;</span><br><span class="line">&lt;insert id=<span class="string">&quot;insertComment&quot;</span> parameterType=<span class="string">&quot;Comment&quot;</span>&gt;</span><br><span class="line">  insert into <span class="title function_">comment</span><span class="params">(&lt;include refid=<span class="string">&quot;insertFields&quot;</span>&gt;&lt;/include&gt;)</span></span><br><span class="line">  values (#&#123;userId&#125;, #&#123;entityType&#125;, #&#123;entityId&#125;, #&#123;targetId&#125;, #&#123;content&#125;, #&#123;status&#125;, #&#123;createTime&#125;)</span><br><span class="line">  &lt;/insert&gt;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//DiscussPostMapper</span></span><br><span class="line">  <span class="type">int</span> <span class="title function_">updateCommentCount</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> <span class="type">int</span> id,<span class="meta">@Param(&quot;commentCount&quot;)</span> <span class="type">int</span> commentCount)</span>;</span><br><span class="line">&lt;update id=<span class="string">&quot;updateCommentCount&quot;</span>&gt;</span><br><span class="line">  update discuss_post <span class="type">set</span> <span class="variable">comment_count</span> <span class="operator">=</span> #&#123;commentCount&#125;</span><br><span class="line"><span class="type">where</span> <span class="variable">id</span> <span class="operator">=</span> #&#123;id&#125;</span><br><span class="line">&lt;/update&gt;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//service</span></span><br><span class="line">  <span class="keyword">public</span> List&lt;Comment&gt; <span class="title function_">findCommentsByEntity</span><span class="params">(<span class="type">int</span> entityType, <span class="type">int</span> entityId, <span class="type">int</span> offset, <span class="type">int</span> limit)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> commentMapper.selectCommentsByEntity(entityType, entityId, offset, limit);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">findCommentCount</span><span class="params">(<span class="type">int</span> entityType, <span class="type">int</span> entityId)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> commentMapper.selectCountByEntity(entityType, entityId);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> discussPostId 用于重定向回当前帖子页</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/add/&#123;discussPostId&#125;&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">addComment</span><span class="params">(<span class="meta">@PathVariable(&quot;discussPostId&quot;)</span> <span class="type">int</span> discussPostId, Comment comment)</span> &#123;</span><br><span class="line">  comment.setUserId(hostHolder.getUser().getId());</span><br><span class="line">  comment.setStatus(<span class="number">0</span>);</span><br><span class="line">  comment.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">  commentService.addComment(comment);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;redirect:/discuss/detail/&quot;</span> + discussPostId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="4-2-2-前端核心"><a href="#4-2-2-前端核心" class="headerlink" title="4.2.2 前端核心"></a>4.2.2 前端核心</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--帖子评论框--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;|/comment/add/$&#123;post.id&#125;|&#125;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">placeholder</span>=<span class="string">&quot;帖子评论框!&quot;</span> <span class="attr">name</span>=<span class="string">&quot;content&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;entityType&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;entityId&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;post.id&#125;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>回帖<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--回复输入框--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;|/comment/add/$&#123;post.id&#125;|&#125;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;content&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;回复输入框&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;entityType&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--回复评论id，即entityType=2的评论id--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;entityId&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;cvo.comment.id&#125;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;#&quot;</span>&gt;</span>回复<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--追加回复框--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;|/comment/add/$&#123;post.id&#125;|&#125;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;content&quot;</span> <span class="attr">th:placeholder</span>=<span class="string">&quot;|回复$&#123;rvo.user.username&#125;|&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;entityType&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;entityId&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;cvo.comment.id&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--回复评论的作者id--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;targetId&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;rvo.user.id&#125;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;#&quot;</span>&gt;</span>回复<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id=""><a href="#" class="headerlink" title=""></a></h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/10/%E9%A6%96%E9%A1%B5%E5%8F%8A%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E6%A8%A1%E5%9D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Daiiiiiiiiiii">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小戴的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/10/%E9%A6%96%E9%A1%B5%E5%8F%8A%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E6%A8%A1%E5%9D%97/" class="post-title-link" itemprop="url">首页及登录注册模块</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-09-10 12:54:22 / 修改时间：12:57:10" itemprop="dateCreated datePublished" datetime="2022-09-10T12:54:22+08:00">2022-09-10</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p> 该项目主要基于SpringBoot构建，整合了Mybaits、Kafka、Elastic Search、Quartz等框架，大致实现了以下功能：</p>
<ul>
<li>登录注册功能：实现MD5加密、使用kaptcha工具生成验证码，使用邮箱完成账号注册，利用拦截器结合ThreadLocal实现登 录认证</li>
<li>构建Trie树，实现在帖子以及评论发布时的敏感词过滤。</li>
<li>整合Redis，利用Redis的zset有序集合完成帖子点赞功能，并通过使用Redis完成缓存优化，缓存验证码</li>
<li>使用ElasticSearch完成对帖子的搜索功能并高亮显示搜索结果</li>
<li>使用kafka中间件实现异步系统消息通知</li>
<li>整合Quartz设置定时任务，并完成帖子统计分数模块以及相应的帖子排行</li>
</ul>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/09/10/%E9%A6%96%E9%A1%B5%E5%8F%8A%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E6%A8%A1%E5%9D%97/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/09/hexo%E6%B7%BB%E5%8A%A0%E4%BB%A3%E7%A0%81%E5%A4%8D%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Daiiiiiiiiiii">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小戴的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/09/hexo%E6%B7%BB%E5%8A%A0%E4%BB%A3%E7%A0%81%E5%A4%8D%E5%88%B6/" class="post-title-link" itemprop="url">hexo添加代码复制【过时】</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-09-09 22:51:41" itemprop="dateCreated datePublished" datetime="2022-09-09T22:51:41+08:00">2022-09-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-10 00:35:52" itemprop="dateModified" datetime="2022-09-10T00:35:52+08:00">2022-09-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%97%A5%E5%B8%B8%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">日常学习</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p> 此方法已过时，新版本的Next主题中可直接在主题配置文件中开启复制代码开关</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">copy_button:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># Show text copy result.</span></span><br><span class="line">    <span class="attr">show_result:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># Available values: default | flat | mac</span></span><br><span class="line">    <span class="attr">style:</span> <span class="string">flat</span></span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/09/09/hexo%E6%B7%BB%E5%8A%A0%E4%BB%A3%E7%A0%81%E5%A4%8D%E5%88%B6/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/09/idea%E6%BF%80%E6%B4%BB%E4%B8%8E%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Daiiiiiiiiiii">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小戴的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/09/idea%E6%BF%80%E6%B4%BB%E4%B8%8E%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">自用Idea激活配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-09-09 22:49:00" itemprop="dateCreated datePublished" datetime="2022-09-09T22:49:00+08:00">2022-09-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-10 01:02:09" itemprop="dateModified" datetime="2022-09-10T01:02:09+08:00">2022-09-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%97%A5%E5%B8%B8%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">日常学习</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p> Idea是个好东西，可是最近从2020升到2021发现原来在用的30重置插件失效了，于是尝试了这个方法，亲测可用</p>
<h2 id="激活"><a href="#激活" class="headerlink" title="激活"></a>激活</h2><h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p>从官网<a target="_blank" rel="noopener" href="https://gitee.com/ja-netfilter/ja-netfilter">下载插件</a>,放到磁盘任意位置[感谢大佬]</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/09/09/idea%E6%BF%80%E6%B4%BB%E4%B8%8E%E9%85%8D%E7%BD%AE/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/09/%E8%A7%A3%E5%86%B3%E7%BD%91%E6%98%93%E4%BA%91UWP%E6%97%A7%E7%89%88%E6%97%A0%E6%B3%95%E7%99%BB%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Daiiiiiiiiiii">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小戴的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/09/%E8%A7%A3%E5%86%B3%E7%BD%91%E6%98%93%E4%BA%91UWP%E6%97%A7%E7%89%88%E6%97%A0%E6%B3%95%E7%99%BB%E5%BD%95/" class="post-title-link" itemprop="url">解决网易云UWP旧版无法登录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-09-09 22:47:00" itemprop="dateCreated datePublished" datetime="2022-09-09T22:47:00+08:00">2022-09-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-10 00:47:53" itemprop="dateModified" datetime="2022-09-10T00:47:53+08:00">2022-09-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9A%8F%E7%AC%94/" itemprop="url" rel="index"><span itemprop="name">随笔</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p> 自留</p>
<p>无法登录情况解决：</p>
<ul>
<li>安装完成后打开应用，点击 [发现音乐]-&gt;[个性推荐]-&gt;[最新音乐] 后即可登录账号使用</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/09/%E8%87%AA%E7%94%A8%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Daiiiiiiiiiii">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小戴的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/09/%E8%87%AA%E7%94%A8%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">自用环境配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-09-09 22:43:00" itemprop="dateCreated datePublished" datetime="2022-09-09T22:43:00+08:00">2022-09-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-10 00:58:31" itemprop="dateModified" datetime="2022-09-10T00:58:31+08:00">2022-09-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%97%A5%E5%B8%B8%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">日常学习</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p> 前几天没留神，下资源的时候被p2p下崽器心态搞崩了，于是乎我就决定重装一下电脑，可是配置环境还是挺费事的，所以我就在这自留一份，等用得着的时候直接拿来用</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/09/09/%E8%87%AA%E7%94%A8%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Daiiiiiiiiiii</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">12</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Daiiiiiiiiiii</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
